{% extends 'base.html' %}

{% block title %}건강 데이터 조회 - 뇌졸중 관리{% endblock %}

{% block header_actions %}
<div class="flex items-center gap-3 text-sm">
    <!-- 알림 아이콘 -->
    <button onclick="showNotifications()" class="relative p-2 hover:bg-gray-100 rounded-lg transition">
        <i data-lucide="bell" class="w-5 h-5 text-gray-600"></i>
        <span id="notificationBadge" class="hidden absolute top-0 right-0 w-2 h-2 bg-red-500 rounded-full"></span>
    </button>
    <a href="/patient/profile" class="font-medium hover:text-teal-600 transition cursor-pointer underline" id="userName">환자</a>님
    <button onclick="handleLogout()" class="text-gray-400 hover:text-gray-600">
        <i data-lucide="log-out" class="w-5 h-5"></i>
    </button>
</div>
{% endblock %}

{% block content %}
<div class="space-y-6 pb-10">
    <!-- 페이지 제목 -->
    <div class="text-center mb-6">
        <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-teal-500 to-pink-600 rounded-full mb-3">
            <i data-lucide="bar-chart-3" class="w-8 h-8 text-white"></i>
        </div>
        <h2 class="text-2xl font-bold text-gray-800">건강 데이터 조회</h2>
        <p class="text-gray-500 text-sm mt-1">나의 건강 기록을 확인하세요</p>
    </div>

    <!-- 뇌졸중 위험도 카드 -->
    <div class="bg-white rounded-2xl shadow-lg p-6 border border-teal-100">
        <!-- 헤더: 제목과 현재 위험도 -->
        <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-2">
                <i data-lucide="activity" class="w-5 h-5 text-teal-600"></i>
                <h3 class="text-lg font-bold text-gray-800">나의 뇌졸중 위험도</h3>
            </div>
            <div class="text-right">
                <div class="flex items-baseline justify-end gap-1">
                    <span class="text-2xl font-bold text-right" id="riskScore">-</span>
                </div>
                <p class="text-xs font-medium mt-0.5" id="riskStatus">데이터 입력 필요</p>
            </div>
        </div>
        
        <!-- 위험도 추이 그래프 (전체 너비) -->
        <div class="bg-white rounded-xl p-4 shadow-sm">
            <div class="flex items-center justify-between mb-2">
                <p class="text-xs text-gray-500">최근 추이</p>
                <p class="text-xs text-gray-400" id="riskDate"></p>
            </div>
            <div class="relative h-48">
                <canvas id="riskTrendChart"></canvas>
            </div>
        </div>
    </div>

    <!-- 통계 요약 -->
    <div class="grid grid-cols-2 gap-4">
        <div class="bg-white rounded-2xl shadow-sm p-5 border border-gray-100">
            <div class="flex items-center gap-3 mb-2">
                <div class="w-10 h-10 bg-blue-50 rounded-full flex items-center justify-center">
                    <i data-lucide="droplet" class="w-5 h-5 text-blue-600"></i>
                </div>
                <div>
                    <p class="text-xs text-gray-500">최근 혈압</p>
                    <p class="text-lg font-bold text-gray-800" id="recentBP">-/-</p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm p-5 border border-gray-100">
            <div class="flex items-center gap-3 mb-2">
                <div class="w-10 h-10 bg-green-50 rounded-full flex items-center justify-center">
                    <i data-lucide="activity" class="w-5 h-5 text-green-600"></i>
                </div>
                <div>
                    <p class="text-xs text-gray-500">최근 혈당</p>
                    <p class="text-lg font-bold text-gray-800" id="recentGlucose">-</p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm p-5 border border-gray-100">
            <div class="flex items-center gap-3 mb-2">
                <div class="w-10 h-10 bg-orange-50 rounded-full flex items-center justify-center">
                    <i data-lucide="weight" class="w-5 h-5 text-orange-600"></i>
                </div>
                <div>
                    <p class="text-xs text-gray-500">최근 체중</p>
                    <p class="text-lg font-bold text-gray-800" id="recentWeight">-</p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm p-5 border border-gray-100">
            <div class="flex items-center gap-3 mb-2">
                <div class="w-10 h-10 bg-teal-50 rounded-full flex items-center justify-center">
                    <i data-lucide="calendar" class="w-5 h-5 text-teal-600"></i>
                </div>
                <div>
                    <p class="text-xs text-gray-500">총 기록</p>
                    <p class="text-lg font-bold text-gray-800" id="totalRecords">0</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 기록 목록 -->
    <div class="bg-white rounded-2xl shadow-sm p-6 border border-gray-100">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-bold text-gray-800">전체 기록</h3>
            <button onclick="refreshData()" class="text-teal-600 hover:text-teal-700">
                <i data-lucide="refresh-cw" class="w-5 h-5"></i>
            </button>
        </div>
        
        <div id="recordsList" class="space-y-3">
            <p class="text-sm text-gray-500 text-center py-8">로딩 중...</p>
        </div>
    </div>

    <!-- 빠른 액션 -->
    <div class="grid grid-cols-2 gap-4">
        <a href="/patient/health-data-input" class="bg-gradient-to-r from-teal-600 to-cyan-600 text-white p-4 rounded-2xl text-center hover:from-teal-700 hover:to-cyan-700 transition shadow-lg">
            <i data-lucide="plus" class="w-6 h-6 mx-auto mb-2"></i>
            <p class="text-sm font-semibold">새 기록 추가</p>
        </a>

        <a href="/patient/basic-info" class="bg-white border-2 border-teal-600 text-teal-600 p-4 rounded-2xl text-center hover:bg-teal-50 transition">
            <i data-lucide="settings" class="w-6 h-6 mx-auto mb-2"></i>
            <p class="text-sm font-semibold">기본 정보</p>
        </a>
    </div>
</div>
{% endblock %}

{% set active_tab = 'inquiry' %}
{% include 'patient/_bottom_nav.html' %}

{% block extra_js %}
{% include 'patient/_common_scripts.html' %}
<script>
let allRecords = [];

// 페이지 로드 시 데이터 불러오기
document.addEventListener('DOMContentLoaded', async () => {
    const user = initPatientPage();
    if (!user) return;
    
    await refreshData();
});

async function refreshData() {
    const user = storage.get('user');
    if (!user || !user.id) return;
    
    try {
        const records = await apiCall(`/health/records/user/${user.id}`, 'GET');
        allRecords = records;
        
        // 통계 계산 및 표시
        displayStatistics(records);
        
        // 기록 목록 표시
        displayRecordsList(records);
        
        // 최신 위험도 표시
        if (records.length > 0 && records[0].stroke_risk_score !== undefined && records[0].stroke_risk_score !== null) {
            displayRiskScore(records[0].stroke_risk_score, records[0].created_at);
        }
        
        // 위험도 추이 그래프 표시
        displayRiskTrendChart(records);
        
    } catch (error) {
        console.error('데이터 로드 오류:', error);
        document.getElementById('recordsList').innerHTML = 
            '<p class="text-sm text-gray-500 text-center py-8">데이터를 불러올 수 없습니다.</p>';
    }
}

function displayStatistics(records) {
    const totalRecordsEl = document.getElementById('totalRecords');
    const recentBPEl = document.getElementById('recentBP');
    const recentGlucoseEl = document.getElementById('recentGlucose');
    const recentWeightEl = document.getElementById('recentWeight');
    
    totalRecordsEl.textContent = `${records.length}회`;
    
    if (records.length === 0) {
        recentBPEl.textContent = '-/-';
        recentGlucoseEl.textContent = '-';
        recentWeightEl.textContent = '-';
        return;
    }
    
    // 최근 혈압
    recentBPEl.textContent = `${records[0].systolic_bp}/${records[0].diastolic_bp} mmHg`;
    
    // 최근 혈당
    recentGlucoseEl.textContent = `${records[0].glucose_level} mg/dL`;
    
    // 최근 체중
    recentWeightEl.textContent = `${records[0].weight_kg} kg`;
}

function displayRecordsList(records) {
    const container = document.getElementById('recordsList');
    
    if (!records || records.length === 0) {
        container.innerHTML = '<p class="text-sm text-gray-500 text-center py-8">아직 기록이 없습니다</p>';
        return;
    }
    
    container.innerHTML = records.map((record, index) => `
        <div class="p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
            <div class="flex items-center justify-between mb-3">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 bg-teal-100 rounded-full flex items-center justify-center">
                        <span class="text-xs font-bold text-teal-600">${index + 1}</span>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-800">${formatDate(record.created_at)}</p>
                        ${record.stroke_risk_score !== undefined && record.stroke_risk_score !== null ? 
                            `<p class="text-xs text-teal-600 font-semibold">위험도: ${record.stroke_risk_score.toFixed(1)}</p>` : 
                            '<p class="text-xs text-gray-400">위험도: 계산 중</p>'}
                    </div>
                </div>
                <button onclick="deleteRecord('${record.id}')" class="text-red-500 hover:text-red-700">
                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                </button>
            </div>
            <div class="grid grid-cols-2 gap-2 text-xs text-gray-600">
                <div class="flex items-center gap-1">
                    <i data-lucide="activity" class="w-3 h-3"></i>
                    <span>혈압: ${record.systolic_bp}/${record.diastolic_bp}</span>
                </div>
                <div class="flex items-center gap-1">
                    <i data-lucide="droplet" class="w-3 h-3"></i>
                    <span>혈당: ${record.glucose_level}</span>
                </div>
                <div class="flex items-center gap-1">
                    <i data-lucide="weight" class="w-3 h-3"></i>
                    <span>체중: ${record.weight_kg}kg</span>
                </div>
                <div class="flex items-center gap-1">
                    <i data-lucide="cigarette" class="w-3 h-3"></i>
                    <span>흡연: ${record.smoking}개비</span>
                </div>
            </div>
        </div>
    `).join('');
    
    lucide.createIcons();
}

function displayRiskScore(score, date) {
    const scoreElement = document.getElementById('riskScore');
    const statusElement = document.getElementById('riskStatus');
    const dateElement = document.getElementById('riskDate');
    
    // null 체크
    if (score === null || score === undefined) {
        scoreElement.textContent = '-';
        statusElement.textContent = '위험도 계산이 필요합니다';
        dateElement.textContent = '';
        return;
    }
    
    scoreElement.textContent = score.toFixed(1);
    dateElement.textContent = formatDate(date);
    
    // 백엔드 기준: 0-20: 낮음, 20-40: 보통, 40-60: 높음, 60+: 매우 높음
    if (score < 20) {
        statusElement.textContent = '낮은 위험도';
        scoreElement.className = 'text-2xl font-bold text-green-600 text-right';
    } else if (score < 40) {
        statusElement.textContent = '보통 위험도';
        scoreElement.className = 'text-2xl font-bold text-yellow-600 text-right';
    } else if (score < 60) {
        statusElement.textContent = '높은 위험도';
        scoreElement.className = 'text-2xl font-bold text-orange-600 text-right';
    } else {
        statusElement.textContent = '매우 높은 위험도';
        scoreElement.className = 'text-2xl font-bold text-red-600 text-right';
    }
}

// 위험도 추이 그래프
let riskTrendChart = null;

function displayRiskTrendChart(records) {
    const ctx = document.getElementById('riskTrendChart');
    if (!ctx) return;
    
    // 위험도가 있는 레코드만 필터링 (최대 7개)
    const recordsWithRisk = records
        .filter(r => r.stroke_risk_score !== null && r.stroke_risk_score !== undefined)
        .slice(0, 7)
        .reverse(); // 오래된 것부터 표시
    
    if (recordsWithRisk.length === 0) {
        ctx.parentElement.innerHTML = '<p class="text-sm text-gray-400 text-center py-8">위험도 데이터가 없습니다</p>';
        return;
    }
    
    // 기존 차트 제거
    if (riskTrendChart) {
        riskTrendChart.destroy();
    }
    
    // 날짜 레이블 생성
    const labels = recordsWithRisk.map(r => {
        const date = new Date(r.created_at);
        return `${date.getMonth() + 1}/${date.getDate()}`;
    });
    
    // 위험도 데이터
    const riskScores = recordsWithRisk.map(r => r.stroke_risk_score);
    
    // 배경색 설정 (위험도에 따라)
    const backgroundColors = riskScores.map(score => {
        if (score < 20) return 'rgba(16, 185, 129, 0.2)'; // 녹색
        if (score < 40) return 'rgba(245, 158, 11, 0.2)'; // 노란색
        if (score < 60) return 'rgba(249, 115, 22, 0.2)'; // 주황색
        return 'rgba(239, 68, 68, 0.2)'; // 빨간색
    });
    
    
    riskTrendChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                data: riskScores,
                backgroundColor: 'rgba(20, 184, 166, 0.1)',
                borderColor: 'rgb(20, 184, 166)',
                borderWidth: 2.5,
                tension: 0.4,
                fill: true,
                pointBackgroundColor: riskScores.map(score => {
                    if (score < 20) return 'rgb(16, 185, 129)';
                    if (score < 40) return 'rgb(245, 158, 11)';
                    if (score < 60) return 'rgb(249, 115, 22)';
                    return 'rgb(239, 68, 68)';
                }),
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: 4,
                pointHoverRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    enabled: true,
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 8,
                    callbacks: {
                        title: function(context) {
                            return context[0].label;
                        },
                        label: function(context) {
                            return '위험도: ' + context.parsed.y.toFixed(1);
                        }
                    }
                }
            },
            scales: {
                y: {
                    display: true,
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                        display: true,
                        font: {
                            size: 10
                        },
                        color: '#9ca3af'
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)',
                        drawBorder: false
                    }
                },
                x: {
                    display: true,
                    ticks: {
                        font: {
                            size: 10
                        },
                        color: '#9ca3af'
                    },
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
}

async function deleteRecord(recordId) {
    if (!confirm('이 기록을 삭제하시겠습니까?')) {
        return;
    }
    
    try {
        await apiCall(`/health/records/${recordId}`, 'DELETE');
        showAlert('기록이 삭제되었습니다.', 'success');
        await refreshData();
    } catch (error) {
        showAlert('삭제에 실패했습니다.', 'error');
    }
}
</script>
{% endblock %}
