{% extends 'base.html' %}

{% block title %}ê±´ê°• ë°ì´í„° ì¡°íšŒ - ë‡Œì¡¸ì¤‘ ê´€ë¦¬{% endblock %}

{% block header_actions %}
<button onclick="goBack()" class="text-gray-600 hover:text-gray-800">
    <i data-lucide="arrow-left" class="w-5 h-5"></i>
</button>
{% endblock %}

{% block content %}
<div class="space-y-6 pb-10">
    <!-- í˜ì´ì§€ ì œëª© -->
    <div class="text-center mb-6">
        <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-teal-500 to-pink-600 rounded-full mb-3">
            <i data-lucide="bar-chart-3" class="w-8 h-8 text-white"></i>
        </div>
        <h2 class="text-2xl font-bold text-gray-800">ê±´ê°• ë°ì´í„° ì¡°íšŒ</h2>
        <p class="text-gray-500 text-sm mt-1">ë‚˜ì˜ ê±´ê°• ê¸°ë¡ì„ í™•ì¸í•˜ì„¸ìš”</p>
    </div>

    <!-- ë‡Œì¡¸ì¤‘ ìœ„í—˜ë„ ì¹´ë“œ -->
    <div class="bg-white rounded-2xl shadow-lg p-6 border border-gray-100">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-bold text-gray-800">í˜„ì¬ ë‡Œì¡¸ì¤‘ ìœ„í—˜ë„</h3>
            <i data-lucide="target" class="w-5 h-5 text-teal-600"></i>
        </div>
        
        <div id="riskScoreContainer" class="text-center py-8">
            <div class="relative inline-block">
                <svg class="w-32 h-32 transform -rotate-90">
                    <circle cx="64" cy="64" r="56" stroke="#e5e7eb" stroke-width="8" fill="none"></circle>
                    <circle 
                        id="riskCircle"
                        cx="64" 
                        cy="64" 
                        r="56" 
                        stroke="#8b5cf6" 
                        stroke-width="8" 
                        fill="none"
                        stroke-dasharray="351.86"
                        stroke-dashoffset="351.86"
                        class="transition-all duration-1000"
                    ></circle>
                </svg>
                <div class="absolute inset-0 flex flex-col items-center justify-center">
                    <div class="text-3xl font-bold text-teal-600" id="riskScore">-</div>
                    <div class="text-xs text-gray-500">ìœ„í—˜ë„</div>
                </div>
            </div>
            <p class="text-sm text-gray-600 mt-4" id="riskStatus">ë°ì´í„°ë¥¼ ì…ë ¥í•˜ê³  ìœ„í—˜ë„ë¥¼ í™•ì¸í•˜ì„¸ìš”</p>
            <p class="text-xs text-gray-500 mt-2" id="riskDate"></p>
        </div>
    </div>

    <!-- í†µê³„ ìš”ì•½ -->
    <div class="grid grid-cols-2 gap-4">
        <div class="bg-white rounded-2xl shadow-sm p-5 border border-gray-100">
            <div class="flex items-center gap-3 mb-2">
                <div class="w-10 h-10 bg-blue-50 rounded-full flex items-center justify-center">
                    <i data-lucide="droplet" class="w-5 h-5 text-blue-600"></i>
                </div>
                <div>
                    <p class="text-xs text-gray-500">í‰ê·  í˜ˆì••</p>
                    <p class="text-lg font-bold text-gray-800" id="avgBP">-/-</p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm p-5 border border-gray-100">
            <div class="flex items-center gap-3 mb-2">
                <div class="w-10 h-10 bg-green-50 rounded-full flex items-center justify-center">
                    <i data-lucide="activity" class="w-5 h-5 text-green-600"></i>
                </div>
                <div>
                    <p class="text-xs text-gray-500">í‰ê·  í˜ˆë‹¹</p>
                    <p class="text-lg font-bold text-gray-800" id="avgGlucose">-</p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm p-5 border border-gray-100">
            <div class="flex items-center gap-3 mb-2">
                <div class="w-10 h-10 bg-orange-50 rounded-full flex items-center justify-center">
                    <i data-lucide="weight" class="w-5 h-5 text-orange-600"></i>
                </div>
                <div>
                    <p class="text-xs text-gray-500">ìµœê·¼ ì²´ì¤‘</p>
                    <p class="text-lg font-bold text-gray-800" id="recentWeight">-</p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm p-5 border border-gray-100">
            <div class="flex items-center gap-3 mb-2">
                <div class="w-10 h-10 bg-teal-50 rounded-full flex items-center justify-center">
                    <i data-lucide="calendar" class="w-5 h-5 text-teal-600"></i>
                </div>
                <div>
                    <p class="text-xs text-gray-500">ì´ ê¸°ë¡</p>
                    <p class="text-lg font-bold text-gray-800" id="totalRecords">0</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ê¸°ë¡ ëª©ë¡ -->
    <div class="bg-white rounded-2xl shadow-sm p-6 border border-gray-100">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-bold text-gray-800">ì „ì²´ ê¸°ë¡</h3>
            <button onclick="refreshData()" class="text-teal-600 hover:text-teal-700">
                <i data-lucide="refresh-cw" class="w-5 h-5"></i>
            </button>
        </div>
        
        <div id="recordsList" class="space-y-3">
            <p class="text-sm text-gray-500 text-center py-8">ë¡œë”© ì¤‘...</p>
        </div>
    </div>

    <!-- ë¹ ë¥¸ ì•¡ì…˜ -->
    <div class="grid grid-cols-2 gap-4">
        <a href="/patient/health-data-input" class="bg-gradient-to-r from-teal-600 to-cyan-600 text-white p-4 rounded-2xl text-center hover:from-teal-700 hover:to-cyan-700 transition shadow-lg">
            <i data-lucide="plus" class="w-6 h-6 mx-auto mb-2"></i>
            <p class="text-sm font-semibold">ìƒˆ ê¸°ë¡ ì¶”ê°€</p>
        </a>

        <a href="/patient/basic-info" class="bg-white border-2 border-teal-600 text-teal-600 p-4 rounded-2xl text-center hover:bg-teal-50 transition">
            <i data-lucide="settings" class="w-6 h-6 mx-auto mb-2"></i>
            <p class="text-sm font-semibold">ê¸°ë³¸ ì •ë³´</p>
        </a>
    </div>
</div>
{% endblock %}

{% block bottom_nav %}
<nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-lg">
    <div class="max-w-md mx-auto px-4 py-3">
        <div class="flex items-center justify-around">
            <a href="/patient/home" class="flex flex-col items-center gap-1 text-gray-400 hover:text-teal-600 transition">
                <i data-lucide="home" class="w-6 h-6"></i>
                <span class="text-xs font-medium">í™ˆ</span>
            </a>
            <a href="/patient/health-data-input" class="flex flex-col items-center gap-1 text-gray-400 hover:text-teal-600 transition">
                <i data-lucide="plus-circle" class="w-6 h-6"></i>
                <span class="text-xs font-medium">ê¸°ë¡</span>
            </a>
            <a href="/patient/health-data-inquiry" class="flex flex-col items-center gap-1 text-teal-600">
                <i data-lucide="line-chart" class="w-6 h-6"></i>
                <span class="text-xs font-medium">ë¶„ì„</span>
            </a>
            <a href="/patient/basic-info" class="flex flex-col items-center gap-1 text-gray-400 hover:text-teal-600 transition">
                <i data-lucide="user" class="w-6 h-6"></i>
                <span class="text-xs font-medium">ì •ë³´</span>
            </a>
        </div>
    </div>
</nav>
{% endblock %}

{% block extra_js %}
<script>
let allRecords = [];

// í˜ì´ì§€ ë¡œë“œ ì‹œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
document.addEventListener('DOMContentLoaded', async () => {
    await refreshData();
});

async function refreshData() {
    const user = storage.get('user');
    
    if (!user || !user.id) {
        window.location.href = '/login';
        return;
    }
    
    try {
        const records = await apiCall(`/health/records/user/${user.id}`, 'GET');
        allRecords = records;
        
        // í†µê³„ ê³„ì‚° ë° í‘œì‹œ
        displayStatistics(records);
        
        // ê¸°ë¡ ëª©ë¡ í‘œì‹œ
        displayRecordsList(records);
        
        // ìµœì‹  ìœ„í—˜ë„ í‘œì‹œ
        if (records.length > 0 && records[0].stroke_risk_score !== undefined) {
            displayRiskScore(records[0].stroke_risk_score, records[0].created_at);
        }
        
    } catch (error) {
        console.error('ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
        document.getElementById('recordsList').innerHTML = 
            '<p class="text-sm text-gray-500 text-center py-8">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
    }
}

function displayStatistics(records) {
    const totalRecordsEl = document.getElementById('totalRecords');
    const avgBPEl = document.getElementById('avgBP');
    const avgGlucoseEl = document.getElementById('avgGlucose');
    const recentWeightEl = document.getElementById('recentWeight');
    
    totalRecordsEl.textContent = records.length;
    
    if (records.length === 0) {
        avgBPEl.textContent = '-/-';
        avgGlucoseEl.textContent = '- mg/dL';
        recentWeightEl.textContent = '- kg';
        return;
    }
    
    // í‰ê·  í˜ˆì•• ê³„ì‚°
    const avgSystolic = Math.round(records.reduce((sum, r) => sum + r.systolic_bp, 0) / records.length);
    const avgDiastolic = Math.round(records.reduce((sum, r) => sum + r.diastolic_bp, 0) / records.length);
    avgBPEl.textContent = `${avgSystolic}/${avgDiastolic}`;
    
    // í‰ê·  í˜ˆë‹¹ ê³„ì‚°
    const avgGlucose = Math.round(records.reduce((sum, r) => sum + r.glucose_level, 0) / records.length);
    avgGlucoseEl.textContent = `${avgGlucose} mg/dL`;
    
    // ìµœê·¼ ì²´ì¤‘
    recentWeightEl.textContent = `${records[0].weight_kg} kg`;
}

function displayRecordsList(records) {
    const container = document.getElementById('recordsList');
    
    if (!records || records.length === 0) {
        container.innerHTML = '<p class="text-sm text-gray-500 text-center py-8">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</p>';
        return;
    }
    
    container.innerHTML = records.map((record, index) => `
        <div class="p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
            <div class="flex items-center justify-between mb-3">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 bg-teal-100 rounded-full flex items-center justify-center">
                        <span class="text-xs font-bold text-teal-600">${index + 1}</span>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-800">${formatDate(record.created_at)}</p>
                        ${record.stroke_risk_score !== undefined ? 
                            `<p class="text-xs text-teal-600 font-semibold">ìœ„í—˜ë„: ${record.stroke_risk_score.toFixed(1)}%</p>` : 
                            ''}
                    </div>
                </div>
                <button onclick="deleteRecord('${record.id}')" class="text-red-500 hover:text-red-700">
                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                </button>
            </div>
            <div class="grid grid-cols-2 gap-2 text-xs text-gray-600">
                <div class="flex items-center gap-1">
                    <i data-lucide="activity" class="w-3 h-3"></i>
                    <span>í˜ˆì••: ${record.systolic_bp}/${record.diastolic_bp}</span>
                </div>
                <div class="flex items-center gap-1">
                    <i data-lucide="droplet" class="w-3 h-3"></i>
                    <span>í˜ˆë‹¹: ${record.glucose_level}</span>
                </div>
                <div class="flex items-center gap-1">
                    <i data-lucide="weight" class="w-3 h-3"></i>
                    <span>ì²´ì¤‘: ${record.weight_kg}kg</span>
                </div>
                <div class="flex items-center gap-1">
                    <i data-lucide="cigarette" class="w-3 h-3"></i>
                    <span>í¡ì—°: ${record.smoking}ê°œë¹„</span>
                </div>
            </div>
        </div>
    `).join('');
    
    lucide.createIcons();
}

function displayRiskScore(score, date) {
    const scoreElement = document.getElementById('riskScore');
    const statusElement = document.getElementById('riskStatus');
    const dateElement = document.getElementById('riskDate');
    const circleElement = document.getElementById('riskCircle');
    
    scoreElement.textContent = score.toFixed(1) + '%';
    dateElement.textContent = 'ì¸¡ì •ì¼: ' + formatDate(date);
    
    // ì›í˜• ì§„í–‰ë°” ì—…ë°ì´íŠ¸
    const circumference = 351.86;
    const offset = circumference - (score / 100) * circumference;
    circleElement.style.strokeDashoffset = offset;
    
    if (score < 5) {
        statusElement.textContent = 'âœ… ë‚®ì€ ìœ„í—˜ë„ - ê±´ê°•í•œ ìƒíƒœì…ë‹ˆë‹¤!';
        statusElement.className = 'text-sm text-green-600 font-medium mt-4';
        circleElement.setAttribute('stroke', '#10b981');
    } else if (score < 10) {
        statusElement.textContent = 'âš ï¸ ë³´í†µ ìœ„í—˜ë„ - ê±´ê°• ê´€ë¦¬ì— ì£¼ì˜í•˜ì„¸ìš”';
        statusElement.className = 'text-sm text-yellow-600 font-medium mt-4';
        circleElement.setAttribute('stroke', '#f59e0b');
    } else {
        statusElement.textContent = 'ğŸš¨ ë†’ì€ ìœ„í—˜ë„ - ì˜ë£Œì§„ ìƒë‹´ì´ í•„ìš”í•©ë‹ˆë‹¤';
        statusElement.className = 'text-sm text-red-600 font-medium mt-4';
        circleElement.setAttribute('stroke', '#ef4444');
    }
}

async function deleteRecord(recordId) {
    if (!confirm('ì´ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
    }
    
    try {
        await apiCall(`/health/records/${recordId}`, 'DELETE');
        showAlert('ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        await refreshData();
    } catch (error) {
        showAlert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
    }
}
</script>
{% endblock %}
