{% extends 'base.html' %}

{% block title %}프로필 수정 - 뇌졸중 관리{% endblock %}

{% block header_actions %}
<button onclick="goBack()" class="text-gray-600 hover:text-gray-800">
    <i data-lucide="arrow-left" class="w-5 h-5"></i>
</button>
{% endblock %}

{% block content %}
<div class="space-y-6 pb-10">
    <!-- 페이지 제목 -->
    <div class="text-center mb-6">
        <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-teal-500 to-cyan-600 rounded-full mb-3">
            <i data-lucide="user-cog" class="w-8 h-8 text-white"></i>
        </div>
        <h2 class="text-2xl font-bold text-gray-800">프로필 수정</h2>
        <p class="text-gray-500 text-sm mt-1">이름과 비밀번호를 변경할 수 있습니다</p>
    </div>

    <!-- 현재 사용자 정보 표시 -->
    <div class="bg-gradient-to-r from-teal-50 to-cyan-50 rounded-2xl p-6 border border-teal-100">
        <div class="flex items-center gap-4">
            <div class="w-16 h-16 bg-teal-500 rounded-full flex items-center justify-center">
                <span class="text-2xl text-white font-bold" id="userInitial">-</span>
            </div>
            <div>
                <p class="text-sm text-gray-500">현재 로그인</p>
                <p class="text-lg font-bold text-gray-800" id="currentName">-</p>
                <p class="text-sm text-gray-600" id="currentId">-</p>
            </div>
        </div>
    </div>

    <!-- 이름 변경 폼 -->
    <div class="bg-white rounded-2xl shadow-sm p-6 border border-gray-100">
        <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
            <i data-lucide="user" class="w-5 h-5 text-teal-600"></i>
            이름 변경
        </h3>
        
        <form id="nameForm" onsubmit="handleNameChange(event)" class="space-y-4">
            <div>
                <label for="newName" class="block text-sm font-medium text-gray-700 mb-2">
                    새 이름 <span class="text-red-500">*</span>
                </label>
                <input 
                    type="text" 
                    id="newName" 
                    name="newName" 
                    required
                    minlength="2"
                    maxlength="20"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent transition"
                    placeholder="변경할 이름을 입력하세요"
                >
            </div>

            <button 
                type="submit" 
                class="w-full bg-gradient-to-r from-teal-600 to-cyan-600 text-white py-3 rounded-lg font-semibold hover:from-teal-700 hover:to-cyan-700 transition duration-300 flex items-center justify-center gap-2"
            >
                <span>이름 변경</span>
                <i data-lucide="check" class="w-5 h-5"></i>
            </button>
        </form>
    </div>

    <!-- 비밀번호 변경 폼 -->
    <div class="bg-white rounded-2xl shadow-sm p-6 border border-gray-100">
        <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
            <i data-lucide="lock" class="w-5 h-5 text-teal-600"></i>
            비밀번호 변경
        </h3>
        
        <form id="passwordForm" onsubmit="handlePasswordChange(event)" class="space-y-4">
            <div>
                <label for="currentPassword" class="block text-sm font-medium text-gray-700 mb-2">
                    현재 비밀번호 <span class="text-red-500">*</span>
                </label>
                <input 
                    type="password" 
                    id="currentPassword" 
                    name="currentPassword" 
                    required
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent transition"
                    placeholder="현재 비밀번호"
                >
            </div>

            <div>
                <label for="newPassword" class="block text-sm font-medium text-gray-700 mb-2">
                    새 비밀번호 <span class="text-red-500">*</span>
                </label>
                <input 
                    type="password" 
                    id="newPassword" 
                    name="newPassword" 
                    required
                    minlength="4"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent transition"
                    placeholder="새 비밀번호 (최소 4자)"
                >
            </div>

            <div>
                <label for="confirmPassword" class="block text-sm font-medium text-gray-700 mb-2">
                    비밀번호 확인 <span class="text-red-500">*</span>
                </label>
                <input 
                    type="password" 
                    id="confirmPassword" 
                    name="confirmPassword" 
                    required
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent transition"
                    placeholder="새 비밀번호 확인"
                >
            </div>

            <button 
                type="submit" 
                class="w-full bg-gradient-to-r from-orange-600 to-red-600 text-white py-3 rounded-lg font-semibold hover:from-orange-700 hover:to-red-700 transition duration-300 flex items-center justify-center gap-2"
            >
                <span>비밀번호 변경</span>
                <i data-lucide="shield-check" class="w-5 h-5"></i>
            </button>
        </form>
    </div>

    <!-- 안내 정보 -->
    <div class="bg-yellow-50 rounded-2xl p-6 border border-yellow-100">
        <div class="flex items-start gap-3">
            <i data-lucide="alert-triangle" class="w-5 h-5 text-yellow-600 mt-0.5"></i>
            <div class="text-sm text-gray-700">
                <p class="font-semibold mb-2">보안 안내</p>
                <ul class="space-y-1 text-gray-600">
                    <li>• 비밀번호는 정기적으로 변경하는 것이 좋습니다</li>
                    <li>• 다른 사람과 비밀번호를 공유하지 마세요</li>
                    <li>• 추측하기 어려운 비밀번호를 사용하세요</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- 로그아웃 버튼 -->
    <div class="pt-4">
        <button 
            onclick="handleLogout()" 
            class="w-full bg-gray-100 text-gray-700 py-3 rounded-lg font-medium hover:bg-gray-200 transition flex items-center justify-center gap-2"
        >
            <i data-lucide="log-out" class="w-5 h-5"></i>
            <span>로그아웃</span>
        </button>
    </div>
</div>
{% endblock %}

{% block bottom_nav %}
<nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-lg">
    <div class="max-w-md mx-auto px-4 py-3">
        <div class="flex items-center justify-around">
            <a href="/patient/home" class="flex flex-col items-center gap-1 text-gray-400 hover:text-teal-600 transition">
                <i data-lucide="home" class="w-6 h-6"></i>
                <span class="text-xs font-medium">홈</span>
            </a>
            <a href="/patient/health-data-input" class="flex flex-col items-center gap-1 text-gray-400 hover:text-teal-600 transition">
                <i data-lucide="plus-circle" class="w-6 h-6"></i>
                <span class="text-xs font-medium">기록</span>
            </a>
            <a href="/patient/health-data-inquiry" class="flex flex-col items-center gap-1 text-gray-400 hover:text-teal-600 transition">
                <i data-lucide="line-chart" class="w-6 h-6"></i>
                <span class="text-xs font-medium">분석</span>
            </a>
            <a href="/patient/basic-info" class="flex flex-col items-center gap-1 text-gray-400 hover:text-teal-600 transition">
                <i data-lucide="user" class="w-6 h-6"></i>
                <span class="text-xs font-medium">정보</span>
            </a>
        </div>
    </div>
</nav>
{% endblock %}

{% block extra_js %}
<script>
let currentUser = null;

// 페이지 로드 시 사용자 정보 표시
document.addEventListener('DOMContentLoaded', async () => {
    currentUser = storage.get('user');
    
    if (!currentUser || !currentUser.id) {
        window.location.href = '/login';
        return;
    }
    
    // 사용자 정보 표시
    document.getElementById('currentName').textContent = currentUser.name || '-';
    document.getElementById('currentId').textContent = `@${currentUser.id}`;
    document.getElementById('userInitial').textContent = currentUser.name ? currentUser.name.charAt(0) : '-';
    document.getElementById('newName').value = currentUser.name || '';
});

// 이름 변경
async function handleNameChange(event) {
    event.preventDefault();
    
    const newName = document.getElementById('newName').value.trim();
    
    if (!newName) {
        showAlert('이름을 입력해주세요.', 'error');
        return;
    }
    
    if (newName === currentUser.name) {
        showAlert('현재 이름과 동일합니다.', 'error');
        return;
    }
    
    try {
        const response = await apiCall(`/users/${currentUser.id}`, 'PUT', {
            id: currentUser.id,
            name: newName
        });
        
        // 로컬 스토리지 업데이트
        currentUser.name = response.name;
        storage.set('user', currentUser);
        
        // UI 업데이트
        document.getElementById('currentName').textContent = response.name;
        document.getElementById('userInitial').textContent = response.name.charAt(0);
        
        showAlert('이름이 변경되었습니다!', 'success');
        
    } catch (error) {
        showAlert(error.message || '이름 변경에 실패했습니다.', 'error');
    }
}

// 비밀번호 변경
async function handlePasswordChange(event) {
    event.preventDefault();
    
    const currentPassword = document.getElementById('currentPassword').value;
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    
    // 유효성 검사
    if (!currentPassword || !newPassword || !confirmPassword) {
        showAlert('모든 필드를 입력해주세요.', 'error');
        return;
    }
    
    if (newPassword !== confirmPassword) {
        showAlert('새 비밀번호가 일치하지 않습니다.', 'error');
        return;
    }
    
    if (newPassword.length < 4) {
        showAlert('비밀번호는 최소 4자 이상이어야 합니다.', 'error');
        return;
    }
    
    if (currentPassword === newPassword) {
        showAlert('현재 비밀번호와 새 비밀번호가 같습니다.', 'error');
        return;
    }
    
    // 현재 비밀번호 확인
    try {
        await apiCall('/users/login', 'POST', {
            id: currentUser.id,
            password: currentPassword
        });
    } catch (error) {
        showAlert('현재 비밀번호가 올바르지 않습니다.', 'error');
        return;
    }
    
    // 비밀번호 변경
    try {
        await apiCall(`/users/${currentUser.id}`, 'PUT', {
            id: currentUser.id,
            password: newPassword
        });
        
        showAlert('비밀번호가 변경되었습니다! 다시 로그인해주세요.', 'success');
        
        // 폼 초기화
        document.getElementById('passwordForm').reset();
        
        // 2초 후 로그아웃
        setTimeout(() => {
            storage.clear();
            window.location.href = '/login';
        }, 2000);
        
    } catch (error) {
        showAlert(error.message || '비밀번호 변경에 실패했습니다.', 'error');
    }
}

// 로그아웃
function handleLogout() {
    if (confirm('로그아웃 하시겠습니까?')) {
        storage.clear();
        showAlert('로그아웃 되었습니다.', 'success');
        setTimeout(() => {
            window.location.href = '/login';
        }, 1000);
    }
}
</script>
{% endblock %}
