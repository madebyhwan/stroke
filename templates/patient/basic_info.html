{% extends 'base.html' %}

{% block title %}기본 정보 입력 - 뇌졸중 관리{% endblock %}

{% block extra_css %}
<style>
/* 사파리 날짜 입력 필드 스타일 수정 */
input[type="date"] {
    -webkit-appearance: none;
    appearance: none;
    min-height: 48px;
    line-height: 1.5;
}

input[type="date"]::-webkit-date-and-time-value {
    text-align: left;
}

input[type="date"]::-webkit-calendar-picker-indicator {
    margin-left: 0;
    padding-left: 0;
}
</style>
{% endblock %}

{% block header_actions %}
<button onclick="goBack()" class="text-gray-600 hover:text-gray-800">
    <i data-lucide="arrow-left" class="w-5 h-5"></i>
</button>
{% endblock %}

{% block content %}
<div class="space-y-6 pb-10">
    <!-- 페이지 제목 -->
    <div class="text-center mb-6">
        <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-blue-500 to-cyan-600 rounded-full mb-3">
            <i data-lucide="user-circle" class="w-8 h-8 text-white"></i>
        </div>
        <h2 class="text-2xl font-bold text-gray-800">기본 건강 정보</h2>
        <p class="text-gray-500 text-sm mt-1">기본적인 건강 정보를 입력하세요</p>
    </div>

    <!-- 기본 정보 폼 -->
    <div class="bg-white rounded-2xl shadow-sm p-6 border border-gray-100">
        <form id="basicInfoForm" onsubmit="handleBasicInfoSubmit(event)" class="space-y-5">
            
            <!-- 성별 -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-3">
                    성별 <span class="text-red-500">*</span>
                </label>
                <div class="flex gap-4">
                    <label class="flex items-center gap-2 flex-1 p-3 border border-gray-300 rounded-lg cursor-pointer hover:border-teal-500 transition">
                        <input type="radio" name="sex" value="M" required class="w-4 h-4 text-teal-600">
                        <span class="text-sm">남성</span>
                    </label>
                    <label class="flex items-center gap-2 flex-1 p-3 border border-gray-300 rounded-lg cursor-pointer hover:border-teal-500 transition">
                        <input type="radio" name="sex" value="F" required class="w-4 h-4 text-teal-600">
                        <span class="text-sm">여성</span>
                    </label>
                </div>
            </div>

            <!-- 생년월일 -->
            <div>
                <label for="birth_date" class="block text-sm font-medium text-gray-700 mb-2">
                    생년월일 <span class="text-red-500">*</span>
                </label>
                <input 
                    type="date" 
                    id="birth_date" 
                    name="birth_date" 
                    required
                    max="2024-12-31"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent transition"
                >
            </div>

            <!-- 키 -->
            <div>
                <label for="height_cm" class="block text-sm font-medium text-gray-700 mb-2">
                    키 (cm) <span class="text-red-500">*</span>
                </label>
                <input 
                    type="number" 
                    id="height_cm" 
                    name="height_cm" 
                    required
                    min="100"
                    max="250"
                    step="1"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent transition"
                    placeholder="예: 170"
                >
            </div>

            <!-- 질병 이력 섹션 -->
            <div class="space-y-3 pt-2">
                <label class="block text-sm font-medium text-gray-700">질병 이력</label>
                
                <!-- 뇌졸중 병력 -->
                <label class="flex items-center gap-2 p-3 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50">
                    <input type="checkbox" name="stroke_history" class="w-4 h-4 text-teal-600 rounded">
                    <span class="text-sm text-gray-700">뇌졸중 이력</span>
                </label>

                <!-- 고혈압 -->
                <label class="flex items-center gap-2 p-3 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50">
                    <input type="checkbox" name="hypertension" class="w-4 h-4 text-teal-600 rounded">
                    <span class="text-sm text-gray-700">고혈압</span>
                </label>

                <!-- 심장질환 -->
                <label class="flex items-center gap-2 p-3 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50">
                    <input type="checkbox" name="heart_disease" class="w-4 h-4 text-teal-600 rounded">
                    <span class="text-sm text-gray-700">심장 질환</span>
                </label>

                <!-- 당뇨병 -->
                <label class="flex items-center gap-2 p-3 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50">
                    <input type="checkbox" name="diabetes" class="w-4 h-4 text-teal-600 rounded">
                    <span class="text-sm text-gray-700">당뇨병</span>
                </label>
            </div>

            <!-- 흡연 이력 -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-3">
                    흡연 이력 <span class="text-red-500">*</span>
                </label>
                <div class="grid grid-cols-3 gap-3">
                    <label class="flex items-center justify-center p-3 border border-gray-300 rounded-lg cursor-pointer hover:border-teal-500 transition text-center">
                        <input type="radio" name="smoking_history" value="NON_SMOKER" required class="hidden peer">
                        <span class="text-sm peer-checked:font-semibold peer-checked:text-teal-600">비흡연</span>
                    </label>
                    <label class="flex items-center justify-center p-3 border border-gray-300 rounded-lg cursor-pointer hover:border-teal-500 transition text-center">
                        <input type="radio" name="smoking_history" value="PAST_SMOKER" required class="hidden peer">
                        <span class="text-sm peer-checked:font-semibold peer-checked:text-teal-600">과거 흡연</span>
                    </label>
                    <label class="flex items-center justify-center p-3 border border-gray-300 rounded-lg cursor-pointer hover:border-teal-500 transition text-center">
                        <input type="radio" name="smoking_history" value="SMOKER" required class="hidden peer">
                        <span class="text-sm peer-checked:font-semibold peer-checked:text-teal-600">현재 흡연</span>
                    </label>
                </div>
            </div>

            <!-- 제출 버튼 -->
            <div class="pt-4">
                <button 
                    type="submit" 
                    class="w-full bg-gradient-to-r from-teal-600 to-cyan-600 text-white py-3 rounded-lg font-semibold hover:from-teal-700 hover:to-cyan-700 transition duration-300 flex items-center justify-center gap-2"
                >
                    <span>저장하기</span>
                    <i data-lucide="save" class="w-5 h-5"></i>
                </button>
            </div>
        </form>
    </div>

    <!-- 안내 정보 -->
    <div class="bg-blue-50 rounded-2xl p-6 border border-blue-100">
        <div class="flex items-start gap-3">
            <i data-lucide="info" class="w-5 h-5 text-blue-600 mt-0.5"></i>
            <div class="text-sm text-gray-700">
                <p class="font-semibold mb-1">기본 정보란?</p>
                <p class="text-gray-600">변하지 않는 고정적인 건강 정보입니다. 이 정보는 뇌졸중 위험도 계산의 기반이 됩니다.</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block bottom_nav %}
<nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-lg">
    <div class="max-w-md mx-auto px-4 py-3">
        <div class="flex items-center justify-around">
            <a href="/patient/home" class="flex flex-col items-center gap-1 text-gray-400 hover:text-teal-600 transition">
                <i data-lucide="home" class="w-6 h-6"></i>
                <span class="text-xs font-medium">홈</span>
            </a>
            <a href="/patient/health-data-input" class="flex flex-col items-center gap-1 text-gray-400 hover:text-teal-600 transition">
                <i data-lucide="plus-circle" class="w-6 h-6"></i>
                <span class="text-xs font-medium">기록</span>
            </a>
            <a href="/patient/health-data-inquiry" class="flex flex-col items-center gap-1 text-gray-400 hover:text-teal-600 transition">
                <i data-lucide="line-chart" class="w-6 h-6"></i>
                <span class="text-xs font-medium">분석</span>
            </a>
            <a href="/patient/basic-info" class="flex flex-col items-center gap-1 text-teal-600">
                <i data-lucide="user" class="w-6 h-6"></i>
                <span class="text-xs font-medium">정보</span>
            </a>
        </div>
    </div>
</nav>
{% endblock %}

{% block extra_js %}
<script>
// 페이지 로드 시 기존 데이터 불러오기
document.addEventListener('DOMContentLoaded', async () => {
    const user = storage.get('user');
    
    if (!user || !user.id) {
        window.location.href = '/login';
        return;
    }
    
    try {
        const healthInfo = await apiCall(`/users/${user.id}/health`, 'GET');
        
        // 폼에 기존 데이터 채우기
        if (healthInfo) {
            // 성별 라디오 버튼
            if (healthInfo.sex) {
                const sexRadio = document.querySelector(`input[name="sex"][value="${healthInfo.sex}"]`);
                if (sexRadio) sexRadio.checked = true;
            }
            
            // 생년월일
            if (healthInfo.birth_date) {
                document.getElementById('birth_date').value = healthInfo.birth_date;
            }
            
            // 키
            if (healthInfo.height_cm) {
                document.getElementById('height_cm').value = healthInfo.height_cm;
            }
            
            // 흡연 이력 라디오 버튼
            if (healthInfo.smoking_history) {
                const smokingRadio = document.querySelector(`input[name="smoking_history"][value="${healthInfo.smoking_history}"]`);
                if (smokingRadio) smokingRadio.checked = true;
            }
            
            // 질병 이력 체크박스
            if (healthInfo.stroke_history) {
                document.querySelector('input[name="stroke_history"]').checked = true;
            }
            if (healthInfo.hypertension) {
                document.querySelector('input[name="hypertension"]').checked = true;
            }
            if (healthInfo.heart_disease) {
                document.querySelector('input[name="heart_disease"]').checked = true;
            }
            if (healthInfo.diabetes) {
                document.querySelector('input[name="diabetes"]').checked = true;
            }
        }
    } catch (error) {
        console.log('기존 데이터 없음 - 신규 입력');
    }
});

async function handleBasicInfoSubmit(event) {
    event.preventDefault();
    
    const user = storage.get('user');
    if (!user || !user.id) {
        window.location.href = '/login';
        return;
    }
    
    const formData = {
        id: user.id,
        sex: document.querySelector('input[name="sex"]:checked').value,
        birth_date: document.getElementById('birth_date').value,
        height_cm: parseInt(document.getElementById('height_cm').value),
        smoking_history: document.querySelector('input[name="smoking_history"]:checked').value,
        stroke_history: document.querySelector('input[name="stroke_history"]').checked,
        hypertension: document.querySelector('input[name="hypertension"]').checked,
        heart_disease: document.querySelector('input[name="heart_disease"]').checked,
        diabetes: document.querySelector('input[name="diabetes"]').checked
    };
    
    try {
        await apiCall(`/users/${user.id}/health`, 'PUT', formData);
        showAlert('기본 정보가 저장되었습니다!', 'success');
        
        setTimeout(() => {
            window.location.href = '/patient/home';
        }, 1500);
        
    } catch (error) {
        showAlert(error.message || '저장에 실패했습니다. 다시 시도해주세요.', 'error');
    }
}
</script>
{% endblock %}
