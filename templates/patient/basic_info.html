{% extends 'base.html' %}

{% block title %}기본 정보 입력 - 뇌졸중 관리{% endblock %}

{% block header_actions %}
<button onclick="goBack()" class="text-gray-600 hover:text-gray-800">
    <i data-lucide="arrow-left" class="w-5 h-5"></i>
</button>
{% endblock %}

{% block content %}
<div class="space-y-6 pb-10">
    <!-- 페이지 제목 -->
    <div class="text-center mb-6">
        <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-blue-500 to-cyan-600 rounded-full mb-3">
            <i data-lucide="user-circle" class="w-8 h-8 text-white"></i>
        </div>
        <h2 class="text-2xl font-bold text-gray-800">기본 건강 정보</h2>
        <p class="text-gray-500 text-sm mt-1">고정적인 건강 정보를 입력하세요</p>
    </div>

    <!-- 기본 정보 폼 -->
    <div class="bg-white rounded-2xl shadow-sm p-6 border border-gray-100">
        <form id="basicInfoForm" onsubmit="handleBasicInfoSubmit(event)" class="space-y-5">
            
            <!-- 성별 -->
            <div>
                <label for="sex" class="block text-sm font-medium text-gray-700 mb-2">
                    성별 <span class="text-red-500">*</span>
                </label>
                <select 
                    id="sex" 
                    name="sex" 
                    required
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent transition"
                >
                    <option value="">선택하세요</option>
                    <option value="MALE">남성</option>
                    <option value="FEMALE">여성</option>
                </select>
            </div>

            <!-- 생년월일 -->
            <div>
                <label for="birth_date" class="block text-sm font-medium text-gray-700 mb-2">
                    생년월일 <span class="text-red-500">*</span>
                </label>
                <input 
                    type="date" 
                    id="birth_date" 
                    name="birth_date" 
                    required
                    max="2024-12-31"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent transition"
                >
            </div>

            <!-- 키 -->
            <div>
                <label for="height_cm" class="block text-sm font-medium text-gray-700 mb-2">
                    키 (cm) <span class="text-red-500">*</span>
                </label>
                <input 
                    type="number" 
                    id="height_cm" 
                    name="height_cm" 
                    required
                    min="100"
                    max="250"
                    step="1"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent transition"
                    placeholder="예: 170"
                >
            </div>

            <!-- 뇌졸중 병력 -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-3">
                    뇌졸중 병력 <span class="text-red-500">*</span>
                </label>
                <div class="flex gap-4">
                    <label class="flex items-center gap-2 flex-1 p-3 border border-gray-300 rounded-lg cursor-pointer hover:border-teal-500 transition">
                        <input type="radio" name="stroke_history" value="true" required class="w-4 h-4 text-teal-600">
                        <span class="text-sm">있음</span>
                    </label>
                    <label class="flex items-center gap-2 flex-1 p-3 border border-gray-300 rounded-lg cursor-pointer hover:border-teal-500 transition">
                        <input type="radio" name="stroke_history" value="false" required class="w-4 h-4 text-teal-600">
                        <span class="text-sm">없음</span>
                    </label>
                </div>
            </div>

            <!-- 고혈압 -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-3">
                    고혈압 <span class="text-red-500">*</span>
                </label>
                <div class="flex gap-4">
                    <label class="flex items-center gap-2 flex-1 p-3 border border-gray-300 rounded-lg cursor-pointer hover:border-teal-500 transition">
                        <input type="radio" name="hypertension" value="true" required class="w-4 h-4 text-teal-600">
                        <span class="text-sm">있음</span>
                    </label>
                    <label class="flex items-center gap-2 flex-1 p-3 border border-gray-300 rounded-lg cursor-pointer hover:border-teal-500 transition">
                        <input type="radio" name="hypertension" value="false" required class="w-4 h-4 text-teal-600">
                        <span class="text-sm">없음</span>
                    </label>
                </div>
            </div>

            <!-- 심장질환 -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-3">
                    심장질환 <span class="text-red-500">*</span>
                </label>
                <div class="flex gap-4">
                    <label class="flex items-center gap-2 flex-1 p-3 border border-gray-300 rounded-lg cursor-pointer hover:border-teal-500 transition">
                        <input type="radio" name="heart_disease" value="true" required class="w-4 h-4 text-teal-600">
                        <span class="text-sm">있음</span>
                    </label>
                    <label class="flex items-center gap-2 flex-1 p-3 border border-gray-300 rounded-lg cursor-pointer hover:border-teal-500 transition">
                        <input type="radio" name="heart_disease" value="false" required class="w-4 h-4 text-teal-600">
                        <span class="text-sm">없음</span>
                    </label>
                </div>
            </div>

            <!-- 당뇨병 -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-3">
                    당뇨병 <span class="text-red-500">*</span>
                </label>
                <div class="flex gap-4">
                    <label class="flex items-center gap-2 flex-1 p-3 border border-gray-300 rounded-lg cursor-pointer hover:border-teal-500 transition">
                        <input type="radio" name="diabetes" value="true" required class="w-4 h-4 text-teal-600">
                        <span class="text-sm">있음</span>
                    </label>
                    <label class="flex items-center gap-2 flex-1 p-3 border border-gray-300 rounded-lg cursor-pointer hover:border-teal-500 transition">
                        <input type="radio" name="diabetes" value="false" required class="w-4 h-4 text-teal-600">
                        <span class="text-sm">없음</span>
                    </label>
                </div>
            </div>

            <!-- 흡연 이력 -->
            <div>
                <label for="smoking_history" class="block text-sm font-medium text-gray-700 mb-2">
                    흡연 이력 <span class="text-red-500">*</span>
                </label>
                <select 
                    id="smoking_history" 
                    name="smoking_history" 
                    required
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent transition"
                >
                    <option value="">선택하세요</option>
                    <option value="NEVER">비흡연</option>
                    <option value="FORMER">과거 흡연</option>
                    <option value="CURRENT">현재 흡연</option>
                </select>
            </div>

            <!-- 제출 버튼 -->
            <div class="pt-4">
                <button 
                    type="submit" 
                    class="w-full bg-gradient-to-r from-teal-600 to-cyan-600 text-white py-3 rounded-lg font-semibold hover:from-teal-700 hover:to-cyan-700 transition duration-300 flex items-center justify-center gap-2"
                >
                    <span>저장하기</span>
                    <i data-lucide="save" class="w-5 h-5"></i>
                </button>
            </div>
        </form>
    </div>

    <!-- 안내 정보 -->
    <div class="bg-blue-50 rounded-2xl p-6 border border-blue-100">
        <div class="flex items-start gap-3">
            <i data-lucide="info" class="w-5 h-5 text-blue-600 mt-0.5"></i>
            <div class="text-sm text-gray-700">
                <p class="font-semibold mb-1">기본 정보란?</p>
                <p class="text-gray-600">변하지 않는 고정적인 건강 정보입니다. 이 정보는 뇌졸중 위험도 계산의 기반이 됩니다.</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block bottom_nav %}
<nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-lg">
    <div class="max-w-md mx-auto px-4 py-3">
        <div class="flex items-center justify-around">
            <a href="/patient/home" class="flex flex-col items-center gap-1 text-gray-400 hover:text-teal-600 transition">
                <i data-lucide="home" class="w-6 h-6"></i>
                <span class="text-xs font-medium">홈</span>
            </a>
            <a href="/patient/health-data-input" class="flex flex-col items-center gap-1 text-gray-400 hover:text-teal-600 transition">
                <i data-lucide="plus-circle" class="w-6 h-6"></i>
                <span class="text-xs font-medium">기록</span>
            </a>
            <a href="/patient/health-data-inquiry" class="flex flex-col items-center gap-1 text-gray-400 hover:text-teal-600 transition">
                <i data-lucide="line-chart" class="w-6 h-6"></i>
                <span class="text-xs font-medium">분석</span>
            </a>
            <a href="/patient/basic-info" class="flex flex-col items-center gap-1 text-teal-600">
                <i data-lucide="user" class="w-6 h-6"></i>
                <span class="text-xs font-medium">정보</span>
            </a>
        </div>
    </div>
</nav>
{% endblock %}

{% block extra_js %}
<script>
// 페이지 로드 시 기존 데이터 불러오기
document.addEventListener('DOMContentLoaded', async () => {
    const user = storage.get('user');
    
    if (!user || !user.id) {
        window.location.href = '/login';
        return;
    }
    
    try {
        const healthInfo = await apiCall(`/users/${user.id}/health`, 'GET');
        
        // 폼에 기존 데이터 채우기
        if (healthInfo) {
            document.getElementById('sex').value = healthInfo.sex || '';
            document.getElementById('birth_date').value = healthInfo.birth_date || '';
            document.getElementById('height_cm').value = healthInfo.height_cm || '';
            document.getElementById('smoking_history').value = healthInfo.smoking_history || '';
            
            // 라디오 버튼
            if (healthInfo.stroke_history !== undefined) {
                document.querySelector(`input[name="stroke_history"][value="${healthInfo.stroke_history}"]`).checked = true;
            }
            if (healthInfo.hypertension !== undefined) {
                document.querySelector(`input[name="hypertension"][value="${healthInfo.hypertension}"]`).checked = true;
            }
            if (healthInfo.heart_disease !== undefined) {
                document.querySelector(`input[name="heart_disease"][value="${healthInfo.heart_disease}"]`).checked = true;
            }
            if (healthInfo.diabetes !== undefined) {
                document.querySelector(`input[name="diabetes"][value="${healthInfo.diabetes}"]`).checked = true;
            }
        }
    } catch (error) {
        console.log('기존 데이터 없음 - 신규 입력');
    }
});

async function handleBasicInfoSubmit(event) {
    event.preventDefault();
    
    const user = storage.get('user');
    if (!user || !user.id) {
        window.location.href = '/login';
        return;
    }
    
    const formData = {
        id: user.id,
        sex: document.getElementById('sex').value,
        birth_date: document.getElementById('birth_date').value,
        height_cm: parseInt(document.getElementById('height_cm').value),
        stroke_history: document.querySelector('input[name="stroke_history"]:checked').value === 'true',
        hypertension: document.querySelector('input[name="hypertension"]:checked').value === 'true',
        heart_disease: document.querySelector('input[name="heart_disease"]:checked').value === 'true',
        smoking_history: document.getElementById('smoking_history').value,
        diabetes: document.querySelector('input[name="diabetes"]:checked').value === 'true'
    };
    
    try {
        await apiCall(`/users/${user.id}/health`, 'PUT', formData);
        showAlert('기본 정보가 저장되었습니다!', 'success');
        
        setTimeout(() => {
            window.location.href = '/patient/home';
        }, 1500);
        
    } catch (error) {
        showAlert(error.message || '저장에 실패했습니다. 다시 시도해주세요.', 'error');
    }
}
</script>
{% endblock %}
