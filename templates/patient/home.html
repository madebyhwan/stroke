{% extends 'base.html' %}

{% block title %}í™ˆ - ë‡Œì¡¸ì¤‘ ê´€ë¦¬{% endblock %}

{% block header_actions %}
<div class="flex items-center gap-2 text-sm">
    <a href="/patient/profile" class="font-medium hover:text-teal-600 transition cursor-pointer underline" id="userName">í™˜ì</a>ë‹˜
    <button onclick="handleLogout()" class="text-gray-400 hover:text-gray-600">
        <i data-lucide="log-out" class="w-5 h-5"></i>
    </button>
</div>
{% endblock %}

{% block content %}
<div class="space-y-6 pb-10">
    <!-- í™˜ì˜ ë©”ì‹œì§€ -->
    <div class="bg-gradient-to-r from-teal-500 to-cyan-600 rounded-2xl p-6 text-white shadow-lg relative overflow-hidden">
        <div class="relative z-10">
            <h2 class="text-2xl font-bold mb-1">ì•ˆë…•í•˜ì„¸ìš”! ğŸ‘‹</h2>
            <p class="text-purple-50 text-sm mb-4" id="welcomeMessage">
                ì˜¤ëŠ˜ë„ ê±´ê°•í•œ í•˜ë£¨ ë³´ë‚´ì„¸ìš”
            </p>
        </div>
        <i data-lucide="heart-pulse" class="absolute -right-4 -bottom-4 w-32 h-32 text-white/10"></i>
    </div>

    <!-- ì£¼ìš” ê¸°ëŠ¥ ê·¸ë¦¬ë“œ -->
    <div class="grid grid-cols-2 gap-4">
        <!-- ê±´ê°• ë°ì´í„° ì…ë ¥ -->
        <a href="/patient/health-data-input" class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 text-center hover:shadow-md transition card-hover group">
            <div class="bg-orange-50 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-3 group-hover:scale-110 transition">
                <i data-lucide="clipboard-list" class="w-6 h-6 text-orange-600"></i>
            </div>
            <h3 class="font-bold text-gray-800">ê±´ê°• ê¸°ë¡</h3>
            <p class="text-xs text-gray-500 mt-1">ì¸¡ì • ë°ì´í„° ì…ë ¥</p>
        </a>

        <!-- ê±´ê°• ë°ì´í„° ì¡°íšŒ -->
        <a href="/patient/health-data-inquiry" class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 text-center hover:shadow-md transition card-hover group">
            <div class="bg-purple-50 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-3 group-hover:scale-110 transition">
                <i data-lucide="bar-chart-3" class="w-6 h-6 text-purple-600"></i>
            </div>
            <h3 class="font-bold text-gray-800">ê±´ê°• ì¡°íšŒ</h3>
            <p class="text-xs text-gray-500 mt-1">ë°ì´í„° í™•ì¸</p>
        </a>
    </div>

    <!-- ë‡Œì¡¸ì¤‘ ìœ„í—˜ë„ ì¹´ë“œ -->
    <div class="bg-white rounded-2xl shadow-sm p-6 border border-gray-100">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-bold text-gray-800">ë‚˜ì˜ ë‡Œì¡¸ì¤‘ ìœ„í—˜ë„</h3>
            <i data-lucide="alert-circle" class="w-5 h-5 text-gray-400"></i>
        </div>
        
        <div id="riskScoreContainer" class="text-center py-6">
            <div class="text-4xl font-bold text-teal-600 mb-2" id="riskScore">-</div>
            <p class="text-sm text-gray-500" id="riskStatus">ë°ì´í„°ë¥¼ ì…ë ¥í•˜ê³  ìœ„í—˜ë„ë¥¼ í™•ì¸í•˜ì„¸ìš”</p>
        </div>

        <button onclick="window.location.href='/patient/health-data-inquiry'" class="w-full mt-4 bg-gray-100 text-gray-700 py-3 rounded-lg font-medium hover:bg-gray-200 transition">
            ìì„¸íˆ ë³´ê¸°
        </button>
    </div>

    <!-- ìµœê·¼ ê±´ê°• ê¸°ë¡ -->
    <div class="bg-white rounded-2xl shadow-sm p-6 border border-gray-100">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-bold text-gray-800">ìµœê·¼ ê±´ê°• ê¸°ë¡</h3>
            <a href="/patient/health-data-inquiry" class="text-purple-600 text-sm font-medium hover:text-purple-700">
                ì „ì²´ë³´ê¸°
            </a>
        </div>
        
        <div id="recentRecords" class="space-y-3">
            <p class="text-sm text-gray-500 text-center py-4">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</p>
        </div>
    </div>

    <!-- ì •ë³´ ì¹´ë“œ -->
    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-2xl p-6 border border-blue-100">
        <div class="flex items-start gap-3">
            <i data-lucide="lightbulb" class="w-5 h-5 text-blue-600 mt-0.5"></i>
            <div class="text-sm text-gray-700">
                <p class="font-semibold mb-1">ê±´ê°• ê´€ë¦¬ íŒ</p>
                <p class="text-gray-600">ê¾¸ì¤€í•œ í˜ˆì•• ê´€ë¦¬ì™€ ê·œì¹™ì ì¸ ìš´ë™ìœ¼ë¡œ ë‡Œì¡¸ì¤‘ ìœ„í—˜ì„ ë‚®ì¶œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block bottom_nav %}
<nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-lg">
    <div class="max-w-md mx-auto px-4 py-3">
        <div class="flex items-center justify-around">
            <a href="/patient/home" class="flex flex-col items-center gap-1 text-teal-600">
                <i data-lucide="home" class="w-6 h-6"></i>
                <span class="text-xs font-medium">í™ˆ</span>
            </a>
            <a href="/patient/health-data-input" class="flex flex-col items-center gap-1 text-gray-400 hover:text-teal-600 transition">
                <i data-lucide="plus-circle" class="w-6 h-6"></i>
                <span class="text-xs font-medium">ê¸°ë¡</span>
            </a>
            <a href="/patient/health-data-inquiry" class="flex flex-col items-center gap-1 text-gray-400 hover:text-teal-600 transition">
                <i data-lucide="line-chart" class="w-6 h-6"></i>
                <span class="text-xs font-medium">ë¶„ì„</span>
            </a>
            <a href="/patient/basic-info" class="flex flex-col items-center gap-1 text-gray-400 hover:text-teal-600 transition">
                <i data-lucide="user" class="w-6 h-6"></i>
                <span class="text-xs font-medium">ì •ë³´</span>
            </a>
        </div>
    </div>
</nav>
{% endblock %}

{% block extra_js %}
<script>
// í˜ì´ì§€ ë¡œë“œ ì‹œ ì‚¬ìš©ì ì •ë³´ ë° ìµœê·¼ ê¸°ë¡ ë¡œë“œ
document.addEventListener('DOMContentLoaded', async () => {
    const user = storage.get('user');
    
    if (!user || !user.id) {
        window.location.href = '/login';
        return;
    }
    
    // ì‚¬ìš©ì ì´ë¦„ í‘œì‹œ
    document.getElementById('userName').textContent = user.name || 'í™˜ì';
    document.getElementById('welcomeMessage').textContent = 
        `${user.name || 'í™˜ì'}ë‹˜, ì˜¤ëŠ˜ë„ ê±´ê°•í•œ í•˜ë£¨ ë³´ë‚´ì„¸ìš”`;
    
    // ìµœê·¼ ê±´ê°• ê¸°ë¡ ë¡œë“œ
    try {
        const records = await apiCall(`/health/records/user/${user.id}`, 'GET');
        displayRecentRecords(records.slice(0, 3)); // ìµœê·¼ 3ê°œë§Œ í‘œì‹œ
        
        // ìµœì‹  ê¸°ë¡ ê¸°ë°˜ ìœ„í—˜ë„ í‘œì‹œ
        if (records.length > 0) {
            const latestRecord = records[0];
            if (latestRecord.stroke_risk_score !== undefined) {
                displayRiskScore(latestRecord.stroke_risk_score);
            }
        }
    } catch (error) {
        console.error('ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
    }
});

function displayRecentRecords(records) {
    const container = document.getElementById('recentRecords');
    
    if (!records || records.length === 0) {
        container.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</p>';
        return;
    }
    
    container.innerHTML = records.map(record => `
        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center">
                    <i data-lucide="activity" class="w-5 h-5 text-purple-600"></i>
                </div>
                <div>
                    <p class="text-sm font-medium text-gray-800">í˜ˆì••: ${record.systolic_bp}/${record.diastolic_bp}</p>
                    <p class="text-xs text-gray-500">${formatDate(record.measured_at)}</p>
                </div>
            </div>
            <i data-lucide="chevron-right" class="w-5 h-5 text-gray-400"></i>
        </div>
    `).join('');
    
    lucide.createIcons();
}

function displayRiskScore(score) {
    const scoreElement = document.getElementById('riskScore');
    const statusElement = document.getElementById('riskStatus');
    
    scoreElement.textContent = score.toFixed(1) + '%';
    
    if (score < 5) {
        statusElement.textContent = 'ë‚®ì€ ìœ„í—˜ë„ - ê±´ê°•í•œ ìƒíƒœë¥¼ ìœ ì§€í•˜ì„¸ìš”!';
        scoreElement.className = 'text-4xl font-bold text-green-600 mb-2';
    } else if (score < 10) {
        statusElement.textContent = 'ë³´í†µ ìœ„í—˜ë„ - ê±´ê°• ê´€ë¦¬ì— ì£¼ì˜í•˜ì„¸ìš”';
        scoreElement.className = 'text-4xl font-bold text-yellow-600 mb-2';
    } else {
        statusElement.textContent = 'ë†’ì€ ìœ„í—˜ë„ - ì˜ë£Œì§„ ìƒë‹´ì´ í•„ìš”í•©ë‹ˆë‹¤';
        scoreElement.className = 'text-4xl font-bold text-red-600 mb-2';
    }
}

function handleLogout() {
    if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        storage.clear();
        showAlert('ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        setTimeout(() => {
            window.location.href = '/login';
        }, 1000);
    }
}
</script>
{% endblock %}
