{% extends 'base.html' %}

{% block title %}í™ˆ - ë‡Œì¡¸ì¤‘ ê´€ë¦¬{% endblock %}

{% block header_actions %}
<div class="flex items-center gap-3 text-sm">
    <!-- ì•Œë¦¼ ì•„ì´ì½˜ -->
    <button onclick="showNotifications()" class="relative p-2 hover:bg-gray-100 rounded-lg transition">
        <i data-lucide="bell" class="w-5 h-5 text-gray-600"></i>
        <span id="notificationBadge" class="hidden absolute top-0 right-0 w-2 h-2 bg-red-500 rounded-full"></span>
    </button>
    <a href="/patient/profile" class="font-medium hover:text-teal-600 transition cursor-pointer underline" id="userName">í™˜ì</a>ë‹˜
    <button onclick="handleLogout()" class="text-gray-400 hover:text-gray-600">
        <i data-lucide="log-out" class="w-5 h-5"></i>
    </button>
</div>
{% endblock %}

{% block content %}
<div class="space-y-6 pb-10">
    <!-- í™˜ì˜ ë©”ì‹œì§€ -->
    <div class="bg-gradient-to-r from-teal-500 to-cyan-600 rounded-2xl p-6 text-white shadow-lg relative overflow-hidden">
        <div class="relative z-10">
            <h2 class="text-2xl font-bold mb-1">ì•ˆë…•í•˜ì„¸ìš”! ğŸ‘‹</h2>
            <p class="text-purple-50 text-sm mb-4" id="welcomeMessage">
                ì˜¤ëŠ˜ë„ ê±´ê°•í•œ í•˜ë£¨ ë³´ë‚´ì„¸ìš”
            </p>
        </div>
        <i data-lucide="heart-pulse" class="absolute -right-4 -bottom-4 w-32 h-32 text-white/10"></i>
    </div>

    <!-- FAST ê²€ì‚¬ ëª¨ë‹¬ -->
    <div id="fastModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl max-w-md w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-gray-800">FAST ë‡Œì¡¸ì¤‘ ìê°€ê²€ì‚¬</h3>
                    <button onclick="closeFastModal()" class="text-gray-400 hover:text-gray-600">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                
                <div class="space-y-4">
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <p class="text-sm text-red-800 font-medium">âš ï¸ ë‹¤ìŒ ì¦ìƒ ì¤‘ í•˜ë‚˜ë¼ë„ ìˆë‹¤ë©´ ì¦‰ì‹œ 119ì— ì—°ë½í•˜ì„¸ìš”!</p>
                    </div>

                    <div class="space-y-3">
                        <div class="border border-gray-200 rounded-lg p-4">
                            <div class="flex items-start gap-3">
                                <div class="w-10 h-10 bg-teal-100 rounded-full flex items-center justify-center flex-shrink-0">
                                    <span class="font-bold text-teal-600">F</span>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-gray-800 mb-1">Face (ì–¼êµ´)</h4>
                                    <p class="text-sm text-gray-600">ì›ƒì„ ë•Œ í•œìª½ ì–¼êµ´ì´ ì²˜ì§€ë‚˜ìš”?</p>
                                </div>
                            </div>
                        </div>

                        <div class="border border-gray-200 rounded-lg p-4">
                            <div class="flex items-start gap-3">
                                <div class="w-10 h-10 bg-teal-100 rounded-full flex items-center justify-center flex-shrink-0">
                                    <span class="font-bold text-teal-600">A</span>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-gray-800 mb-1">Arm (íŒ”)</h4>
                                    <p class="text-sm text-gray-600">ì–‘íŒ”ì„ ë“¤ ë•Œ í•œìª½ íŒ”ì´ ë‚´ë ¤ê°€ë‚˜ìš”?</p>
                                </div>
                            </div>
                        </div>

                        <div class="border border-gray-200 rounded-lg p-4">
                            <div class="flex items-start gap-3">
                                <div class="w-10 h-10 bg-teal-100 rounded-full flex items-center justify-center flex-shrink-0">
                                    <span class="font-bold text-teal-600">S</span>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-gray-800 mb-1">Speech (ì–¸ì–´)</h4>
                                    <p class="text-sm text-gray-600">ë§í•  ë•Œ ë°œìŒì´ ì–´ëˆŒí•˜ê±°ë‚˜ ì´ìƒí•œê°€ìš”?</p>
                                </div>
                            </div>
                        </div>

                        <div class="border border-gray-200 rounded-lg p-4">
                            <div class="flex items-start gap-3">
                                <div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center flex-shrink-0">
                                    <span class="font-bold text-red-600">T</span>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-gray-800 mb-1">Time (ì‹œê°„)</h4>
                                    <p class="text-sm text-gray-600">ìœ„ ì¦ìƒì´ ìˆë‹¤ë©´ ì¦‰ì‹œ 119ì— ì „í™”í•˜ì„¸ìš”!</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="pt-4 space-y-2">
                        <button onclick="closeFastModal()" class="w-full bg-gradient-to-r from-teal-600 to-cyan-600 text-white py-3 rounded-lg font-semibold hover:from-teal-700 hover:to-cyan-700 transition">
                            í™•ì¸í–ˆìŠµë‹ˆë‹¤
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ì£¼ìš” ê¸°ëŠ¥ ê·¸ë¦¬ë“œ -->
    <div class="grid grid-cols-2 gap-4">
        <!-- ê±´ê°• ë°ì´í„° ì…ë ¥ -->
        <a href="/patient/health-data-input" class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 text-center hover:shadow-md transition card-hover group">
            <div class="bg-orange-50 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-3 group-hover:scale-110 transition">
                <i data-lucide="clipboard-list" class="w-6 h-6 text-orange-600"></i>
            </div>
            <h3 class="font-bold text-gray-800">ê±´ê°• ê¸°ë¡</h3>
            <p class="text-xs text-gray-500 mt-1">ì¸¡ì • ë°ì´í„° ì…ë ¥</p>
        </a>

        <!-- ê±´ê°• ë°ì´í„° ì¡°íšŒ -->
        <a href="/patient/health-data-inquiry" class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 text-center hover:shadow-md transition card-hover group">
            <div class="bg-purple-50 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-3 group-hover:scale-110 transition">
                <i data-lucide="bar-chart-3" class="w-6 h-6 text-purple-600"></i>
            </div>
            <h3 class="font-bold text-gray-800">ê±´ê°• ì¡°íšŒ</h3>
            <p class="text-xs text-gray-500 mt-1">ë°ì´í„° í™•ì¸</p>
        </a>
    </div>

    <!-- ë‡Œì¡¸ì¤‘ ìœ„í—˜ë„ ì¹´ë“œ -->
    <div class="bg-white rounded-2xl shadow-sm p-6 border border-gray-100">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-bold text-gray-800">ë‚˜ì˜ ë‡Œì¡¸ì¤‘ ìœ„í—˜ë„</h3>
            <i data-lucide="alert-circle" class="w-5 h-5 text-gray-400"></i>
        </div>
        
        <div id="riskScoreContainer" class="text-center py-6">
            <div class="text-4xl font-bold text-teal-600 mb-2" id="riskScore">-</div>
            <p class="text-sm text-gray-500" id="riskStatus">ë°ì´í„°ë¥¼ ì…ë ¥í•˜ê³  ìœ„í—˜ë„ë¥¼ í™•ì¸í•˜ì„¸ìš”</p>
        </div>

        <button onclick="window.location.href='/patient/health-data-inquiry'" class="w-full mt-4 bg-gray-100 text-gray-700 py-3 rounded-lg font-medium hover:bg-gray-200 transition">
            ìì„¸íˆ ë³´ê¸°
        </button>
    </div>

    <!-- ìµœê·¼ ê±´ê°• ê¸°ë¡ -->
    <div class="bg-white rounded-2xl shadow-sm p-6 border border-gray-100">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-bold text-gray-800">ìµœê·¼ ê±´ê°• ê¸°ë¡</h3>
            <a href="/patient/health-data-inquiry" class="text-purple-600 text-sm font-medium hover:text-purple-700">
                ì „ì²´ë³´ê¸°
            </a>
        </div>
        
        <div id="recentRecords" class="space-y-3">
            <p class="text-sm text-gray-500 text-center py-4">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</p>
        </div>
    </div>

    <!-- ì •ë³´ ì¹´ë“œ -->
    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-2xl p-6 border border-blue-100">
        <div class="flex items-start gap-3">
            <i data-lucide="lightbulb" class="w-5 h-5 text-blue-600 mt-0.5"></i>
            <div class="text-sm text-gray-700">
                <p class="font-semibold mb-1">ê±´ê°• ê´€ë¦¬ íŒ</p>
                <p class="text-gray-600">ê¾¸ì¤€í•œ í˜ˆì•• ê´€ë¦¬ì™€ ê·œì¹™ì ì¸ ìš´ë™ìœ¼ë¡œ ë‡Œì¡¸ì¤‘ ìœ„í—˜ì„ ë‚®ì¶œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% set active_tab = 'home' %}
{% include 'patient/_bottom_nav.html' %}

{% block extra_js %}
{% include 'patient/_common_scripts.html' %}
<script>
// í˜ì´ì§€ ë¡œë“œ ì‹œ ì‚¬ìš©ì ì •ë³´ ë° ìµœê·¼ ê¸°ë¡ ë¡œë“œ
document.addEventListener('DOMContentLoaded', async () => {
    const user = initPatientPage();
    if (!user) return;
    
    // í™˜ì˜ ë©”ì‹œì§€ í‘œì‹œ
    document.getElementById('welcomeMessage').textContent = 
        `${user.name || 'í™˜ì'}ë‹˜, ì˜¤ëŠ˜ë„ ê±´ê°•í•œ í•˜ë£¨ ë³´ë‚´ì„¸ìš”`;
    
    // FAST ê²€ì‚¬ ëª¨ë‹¬ í‘œì‹œ (ì˜¤ëŠ˜ í•˜ë£¨ ë³´ì§€ ì•Šê¸° ì²´í¬)
    const today = new Date().toDateString();
    const fastModalHidden = storage.get('fastModalHidden');
    
    if (!fastModalHidden || fastModalHidden !== today) {
        showFastModal();
    }
    
    // ìµœê·¼ ê±´ê°• ê¸°ë¡ ë¡œë“œ
    try {
        const records = await apiCall(`/health/records/user/${user.id}`, 'GET');
        displayRecentRecords(records.slice(0, 3)); // ìµœê·¼ 3ê°œë§Œ í‘œì‹œ
        
        // ìµœì‹  ê¸°ë¡ ê¸°ë°˜ ìœ„í—˜ë„ í‘œì‹œ
        if (records.length > 0) {
            const latestRecord = records[0];
            if (latestRecord.stroke_risk_score !== undefined) {
                displayRiskScore(latestRecord.stroke_risk_score);
            }
        }
    } catch (error) {
        console.error('ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
    }
});

function showFastModal() {
    const modal = document.getElementById('fastModal');
    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    lucide.createIcons();
}

function closeFastModal() {
    const today = new Date().toDateString();
    storage.set('fastModalHidden', today);
    
    const modal = document.getElementById('fastModal');
    modal.classList.add('hidden');
    
    document.body.style.overflow = '';
}

function displayRecentRecords(records) {
    const container = document.getElementById('recentRecords');
    
    if (!records || records.length === 0) {
        container.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</p>';
        return;
    }
    
    container.innerHTML = records.map(record => `
        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center">
                    <i data-lucide="activity" class="w-5 h-5 text-purple-600"></i>
                </div>
                <div>
                    <p class="text-sm font-medium text-gray-800">í˜ˆì••: ${record.systolic_bp}/${record.diastolic_bp}</p>
                    <p class="text-xs text-gray-500">${formatDate(record.created_at)}</p>
                </div>
            </div>
            <i data-lucide="chevron-right" class="w-5 h-5 text-gray-400"></i>
        </div>
    `).join('');
    
    lucide.createIcons();
}

function displayRiskScore(score) {
    const scoreElement = document.getElementById('riskScore');
    const statusElement = document.getElementById('riskStatus');
    
    scoreElement.textContent = score.toFixed(1) + '%';
    
    if (score < 5) {
        statusElement.textContent = 'ë‚®ì€ ìœ„í—˜ë„ - ê±´ê°•í•œ ìƒíƒœë¥¼ ìœ ì§€í•˜ì„¸ìš”!';
        scoreElement.className = 'text-4xl font-bold text-green-600 mb-2';
    } else if (score < 10) {
        statusElement.textContent = 'ë³´í†µ ìœ„í—˜ë„ - ê±´ê°• ê´€ë¦¬ì— ì£¼ì˜í•˜ì„¸ìš”';
        scoreElement.className = 'text-4xl font-bold text-yellow-600 mb-2';
    } else {
        statusElement.textContent = 'ë†’ì€ ìœ„í—˜ë„ - ì˜ë£Œì§„ ìƒë‹´ì´ í•„ìš”í•©ë‹ˆë‹¤';
        scoreElement.className = 'text-4xl font-bold text-red-600 mb-2';
    }
}
</script>
{% endblock %}
