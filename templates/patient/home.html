{% extends 'base.html' %}

{% block title %}í™ˆ - ë‡Œì¡¸ì¤‘ ê´€ë¦¬{% endblock %}

{% block header_actions %}
<div class="flex items-center gap-3 text-sm">
    <!-- ì•Œë¦¼ ì•„ì´ì½˜ -->
    <button onclick="showNotifications()" class="relative p-2 hover:bg-gray-100 rounded-lg transition">
        <i data-lucide="bell" class="w-5 h-5 text-gray-600"></i>
        <span id="notificationBadge" class="hidden absolute top-0 right-0 w-2 h-2 bg-red-500 rounded-full"></span>
    </button>
    <a href="/patient/profile" class="font-medium hover:text-teal-600 transition cursor-pointer underline" id="userName">í™˜ì</a>ë‹˜
    <button onclick="handleLogout()" class="text-gray-400 hover:text-gray-600">
        <i data-lucide="log-out" class="w-5 h-5"></i>
    </button>
</div>
{% endblock %}

{% block content %}
<div class="space-y-6 pb-10">
    <!-- í™˜ì˜ ë©”ì‹œì§€ -->
    <div class="bg-gradient-to-r from-teal-500 to-cyan-600 rounded-2xl p-6 text-white shadow-lg relative overflow-hidden">
        <div class="relative z-10">
            <h2 class="text-2xl font-bold mb-1">ì•ˆë…•í•˜ì„¸ìš”! ğŸ‘‹</h2>
            <p class="text-purple-50 text-sm mb-4" id="welcomeMessage">
                ì˜¤ëŠ˜ë„ ê±´ê°•í•œ í•˜ë£¨ ë³´ë‚´ì„¸ìš”
            </p>
        </div>
        <i data-lucide="heart-pulse" class="absolute -right-4 -bottom-4 w-32 h-32 text-white/10"></i>
    </div>

    <!-- FAST ê²€ì‚¬ ëª¨ë‹¬ -->
    <div id="fastModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl max-w-md w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-gray-800">FAST ë‡Œì¡¸ì¤‘ ìê°€ê²€ì‚¬</h3>
                    <button onclick="closeFastModal()" class="text-gray-400 hover:text-gray-600">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                
                <div class="space-y-4">
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <p class="text-sm text-red-800 font-medium">âš ï¸ ë‹¤ìŒ ì¦ìƒ ì¤‘ í•˜ë‚˜ë¼ë„ ìˆë‹¤ë©´ ì¦‰ì‹œ 119ì— ì—°ë½í•˜ì„¸ìš”!</p>
                    </div>

                    <div class="space-y-3">
                        <div class="border border-gray-200 rounded-lg p-4">
                            <div class="flex items-start gap-3">
                                <div class="w-10 h-10 bg-teal-100 rounded-full flex items-center justify-center flex-shrink-0">
                                    <span class="font-bold text-teal-600">F</span>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-gray-800 mb-1">Face (ì–¼êµ´)</h4>
                                    <p class="text-sm text-gray-600">ì›ƒì„ ë•Œ í•œìª½ ì–¼êµ´ì´ ì²˜ì§€ë‚˜ìš”?</p>
                                </div>
                            </div>
                        </div>

                        <div class="border border-gray-200 rounded-lg p-4">
                            <div class="flex items-start gap-3">
                                <div class="w-10 h-10 bg-teal-100 rounded-full flex items-center justify-center flex-shrink-0">
                                    <span class="font-bold text-teal-600">A</span>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-gray-800 mb-1">Arm (íŒ”)</h4>
                                    <p class="text-sm text-gray-600">ì–‘íŒ”ì„ ë“¤ ë•Œ í•œìª½ íŒ”ì´ ë‚´ë ¤ê°€ë‚˜ìš”?</p>
                                </div>
                            </div>
                        </div>

                        <div class="border border-gray-200 rounded-lg p-4">
                            <div class="flex items-start gap-3">
                                <div class="w-10 h-10 bg-teal-100 rounded-full flex items-center justify-center flex-shrink-0">
                                    <span class="font-bold text-teal-600">S</span>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-gray-800 mb-1">Speech (ì–¸ì–´)</h4>
                                    <p class="text-sm text-gray-600">ë§í•  ë•Œ ë°œìŒì´ ì–´ëˆŒí•˜ê±°ë‚˜ ì´ìƒí•œê°€ìš”?</p>
                                </div>
                            </div>
                        </div>

                        <div class="border border-gray-200 rounded-lg p-4">
                            <div class="flex items-start gap-3">
                                <div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center flex-shrink-0">
                                    <span class="font-bold text-red-600">T</span>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-gray-800 mb-1">Time (ì‹œê°„)</h4>
                                    <p class="text-sm text-gray-600">ìœ„ ì¦ìƒì´ ìˆë‹¤ë©´ ì¦‰ì‹œ 119ì— ì „í™”í•˜ì„¸ìš”!</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="pt-4 space-y-2">
                        <button onclick="closeFastModal()" class="w-full bg-gradient-to-r from-teal-600 to-cyan-600 text-white py-3 rounded-lg font-semibold hover:from-teal-700 hover:to-cyan-700 transition">
                            í™•ì¸í–ˆìŠµë‹ˆë‹¤
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ì£¼ìš” ê¸°ëŠ¥ ê·¸ë¦¬ë“œ -->
    <div class="grid grid-cols-2 gap-4">
        <!-- ê±´ê°• ë°ì´í„° ì…ë ¥ -->
        <a href="/patient/health-data-input" class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 text-center hover:shadow-md transition card-hover group">
            <div class="bg-orange-50 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-3 group-hover:scale-110 transition">
                <i data-lucide="clipboard-list" class="w-6 h-6 text-orange-600"></i>
            </div>
            <h3 class="font-bold text-gray-800">ê±´ê°• ê¸°ë¡</h3>
            <p class="text-xs text-gray-500 mt-1">ì¸¡ì • ë°ì´í„° ì…ë ¥</p>
        </a>

        <!-- ê±´ê°• ë°ì´í„° ì¡°íšŒ -->
        <a href="/patient/health-data-inquiry" class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 text-center hover:shadow-md transition card-hover group">
            <div class="bg-purple-50 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-3 group-hover:scale-110 transition">
                <i data-lucide="bar-chart-3" class="w-6 h-6 text-purple-600"></i>
            </div>
            <h3 class="font-bold text-gray-800">ê±´ê°• ì¡°íšŒ</h3>
            <p class="text-xs text-gray-500 mt-1">ë°ì´í„° í™•ì¸</p>
        </a>
    </div>

    <!-- ë‡Œì¡¸ì¤‘ ìœ„í—˜ë„ ì¹´ë“œ -->
    <div class="bg-white rounded-2xl shadow-lg p-6 border border-teal-100">
        <!-- í—¤ë”: ì œëª©ê³¼ í˜„ì¬ ìœ„í—˜ë„ -->
        <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-2">
                <i data-lucide="activity" class="w-5 h-5 text-teal-600"></i>
                <h3 class="text-lg font-bold text-gray-800">ë‚˜ì˜ ë‡Œì¡¸ì¤‘ ìœ„í—˜ë„</h3>
            </div>
            <div class="text-right">
                <div class="flex items-baseline justify-end gap-1">
                    <span class="text-2xl font-bold text-right" id="riskScore">-</span>
                </div>
                <p class="text-xs font-medium mt-0.5" id="riskStatus">ë°ì´í„° ì…ë ¥ í•„ìš”</p>
            </div>
        </div>
        
        <!-- ìœ„í—˜ë„ ì¶”ì´ ê·¸ë˜í”„ (ì „ì²´ ë„ˆë¹„) -->
        <div class="bg-white rounded-xl p-4 shadow-sm mb-4">
            <div class="flex items-center justify-between mb-2">
                <p class="text-xs text-gray-500">ìµœê·¼ ì¶”ì´</p>
                <p class="text-xs text-gray-400" id="riskDate"></p>
            </div>
            <div class="relative h-48">
                <canvas id="homeRiskTrendChart"></canvas>
            </div>
        </div>

        <button onclick="window.location.href='/patient/health-data-inquiry'" class="w-full bg-teal-600 text-white py-3 rounded-lg font-medium hover:bg-teal-700 transition shadow-sm">
            ìƒì„¸ ë¶„ì„ ë³´ê¸°
        </button>
    </div>

    <!-- ìµœê·¼ ê±´ê°• ê¸°ë¡ -->
    <div class="bg-white rounded-2xl shadow-sm p-6 border border-gray-100">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-bold text-gray-800">ìµœê·¼ ê±´ê°• ê¸°ë¡</h3>
            <a href="/patient/health-data-inquiry" class="text-purple-600 text-sm font-medium hover:text-purple-700">
                ì „ì²´ë³´ê¸°
            </a>
        </div>
        
        <div id="recentRecords" class="space-y-3">
            <p class="text-sm text-gray-500 text-center py-4">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</p>
        </div>
    </div>

    <!-- ì •ë³´ ì¹´ë“œ -->
    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-2xl p-6 border border-blue-100">
        <div class="flex items-start gap-3">
            <i data-lucide="lightbulb" class="w-5 h-5 text-blue-600 mt-0.5"></i>
            <div class="text-sm text-gray-700">
                <p class="font-semibold mb-1">ê±´ê°• ê´€ë¦¬ íŒ</p>
                <p class="text-gray-600">ê¾¸ì¤€í•œ í˜ˆì•• ê´€ë¦¬ì™€ ê·œì¹™ì ì¸ ìš´ë™ìœ¼ë¡œ ë‡Œì¡¸ì¤‘ ìœ„í—˜ì„ ë‚®ì¶œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% set active_tab = 'home' %}
{% include 'patient/_bottom_nav.html' %}

{% block extra_js %}
{% include 'patient/_common_scripts.html' %}
<script>
// í˜ì´ì§€ ë¡œë“œ ì‹œ ì‚¬ìš©ì ì •ë³´ ë° ìµœê·¼ ê¸°ë¡ ë¡œë“œ
document.addEventListener('DOMContentLoaded', async () => {
    const user = initPatientPage();
    if (!user) return;
    
    // í™˜ì˜ ë©”ì‹œì§€ í‘œì‹œ
    document.getElementById('welcomeMessage').textContent = 
        `${user.name || 'í™˜ì'}ë‹˜, ì˜¤ëŠ˜ë„ ê±´ê°•í•œ í•˜ë£¨ ë³´ë‚´ì„¸ìš”`;
    
    // FAST ê²€ì‚¬ ëª¨ë‹¬ í‘œì‹œ (ì˜¤ëŠ˜ í•˜ë£¨ ë³´ì§€ ì•Šê¸° ì²´í¬)
    const today = new Date().toDateString();
    const fastModalHidden = storage.get('fastModalHidden');
    
    if (!fastModalHidden || fastModalHidden !== today) {
        showFastModal();
    }
    
    // ìµœê·¼ ê±´ê°• ê¸°ë¡ ë¡œë“œ
    try {
        const records = await apiCall(`/health/records/user/${user.id}`, 'GET');
        displayRecentRecords(records.slice(0, 3)); // ìµœê·¼ 3ê°œë§Œ í‘œì‹œ
        
        // ìµœì‹  ê¸°ë¡ ê¸°ë°˜ ìœ„í—˜ë„ í‘œì‹œ
        if (records.length > 0) {
            const latestRecord = records[0];
            if (latestRecord.stroke_risk_score !== undefined && latestRecord.stroke_risk_score !== null) {
                displayRiskScore(latestRecord.stroke_risk_score);
                document.getElementById('riskDate').textContent = formatDate(latestRecord.created_at);
            }
        }
        
        // ìœ„í—˜ë„ ì¶”ì´ ê·¸ë˜í”„ í‘œì‹œ
        displayHomeRiskTrendChart(records);
        
    } catch (error) {
        console.error('ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
    }
});

function showFastModal() {
    const modal = document.getElementById('fastModal');
    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    lucide.createIcons();
}

function closeFastModal() {
    const today = new Date().toDateString();
    storage.set('fastModalHidden', today);
    
    const modal = document.getElementById('fastModal');
    modal.classList.add('hidden');
    
    document.body.style.overflow = '';
}

function displayRecentRecords(records) {
    const container = document.getElementById('recentRecords');
    
    if (!records || records.length === 0) {
        container.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</p>';
        return;
    }
    
    container.innerHTML = records.map(record => {
        // ìœ„í—˜ë„ ì •ë³´
        let riskText = 'ìœ„í—˜ë„ ë¯¸ê³„ì‚°';
        let riskColor = 'text-gray-500';
        
        if (record.stroke_risk_score !== null && record.stroke_risk_score !== undefined) {
            const score = record.stroke_risk_score;
            riskText = `ìœ„í—˜ë„ ${score.toFixed(1)}`;
            
            if (score < 20) {
                riskColor = 'text-green-600';
            } else if (score < 40) {
                riskColor = 'text-yellow-600';
            } else if (score < 60) {
                riskColor = 'text-orange-600';
            } else {
                riskColor = 'text-red-600';
            }
        }
        
        return `
            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-teal-100 rounded-full flex items-center justify-center">
                        <i data-lucide="activity" class="w-5 h-5 text-teal-600"></i>
                    </div>
                    <div>
                        <p class="text-base font-bold text-gray-800">${formatDate(record.created_at)}</p>
                        <p class="text-xs ${riskColor} mt-0.5 font-medium">${riskText}</p>
                    </div>
                </div>
                <i data-lucide="chevron-right" class="w-5 h-5 text-gray-400"></i>
            </div>
        `;
    }).join('');
    
    lucide.createIcons();
}

function displayRiskScore(score) {
    const scoreElement = document.getElementById('riskScore');
    const statusElement = document.getElementById('riskStatus');
    
    // null ì²´í¬
    if (score === null || score === undefined) {
        scoreElement.textContent = '-';
        statusElement.textContent = 'ìœ„í—˜ë„ ê³„ì‚°ì´ í•„ìš”í•©ë‹ˆë‹¤';
        return;
    }
    
    scoreElement.textContent = score.toFixed(1);
    
    // ë°±ì—”ë“œ ê¸°ì¤€: 0-20: ë‚®ìŒ, 20-40: ë³´í†µ, 40-60: ë†’ìŒ, 60+: ë§¤ìš° ë†’ìŒ
    if (score < 20) {
        statusElement.textContent = 'ë‚®ì€ ìœ„í—˜ë„';
        scoreElement.className = 'text-2xl font-bold text-green-600 text-right';
    } else if (score < 40) {
        statusElement.textContent = 'ë³´í†µ ìœ„í—˜ë„';
        scoreElement.className = 'text-2xl font-bold text-yellow-600 text-right';
    } else if (score < 60) {
        statusElement.textContent = 'ë†’ì€ ìœ„í—˜ë„';
        scoreElement.className = 'text-2xl font-bold text-orange-600 text-right';
    } else {
        statusElement.textContent = 'ë§¤ìš° ë†’ì€ ìœ„í—˜ë„';
        scoreElement.className = 'text-2xl font-bold text-red-600 text-right';
    }
}

// í™ˆ í™”ë©´ ìœ„í—˜ë„ ì¶”ì´ ê·¸ë˜í”„ (ì‘ì€ ë²„ì „)
let homeRiskTrendChart = null;

function displayHomeRiskTrendChart(records) {
    const ctx = document.getElementById('homeRiskTrendChart');
    if (!ctx) return;
    
    // ìœ„í—˜ë„ê°€ ìˆëŠ” ë ˆì½”ë“œë§Œ í•„í„°ë§ (ìµœëŒ€ 7ê°œ)
    const recordsWithRisk = records
        .filter(r => r.stroke_risk_score !== null && r.stroke_risk_score !== undefined)
        .slice(0, 7)
        .reverse(); // ì˜¤ë˜ëœ ê²ƒë¶€í„° í‘œì‹œ
    
    if (recordsWithRisk.length === 0) {
        ctx.parentElement.innerHTML = '<p class="text-sm text-gray-400 text-center py-8">ìœ„í—˜ë„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</p>';
        return;
    }
    
    // ê¸°ì¡´ ì°¨íŠ¸ ì œê±°
    if (homeRiskTrendChart) {
        homeRiskTrendChart.destroy();
    }
    
    // ë‚ ì§œ ë ˆì´ë¸” ìƒì„±
    const labels = recordsWithRisk.map(r => {
        const date = new Date(r.created_at);
        return `${date.getMonth() + 1}/${date.getDate()}`;
    });
    
    // ìœ„í—˜ë„ ë°ì´í„°
    const riskScores = recordsWithRisk.map(r => r.stroke_risk_score);
    
    homeRiskTrendChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                data: riskScores,
                backgroundColor: 'rgba(20, 184, 166, 0.1)',
                borderColor: 'rgb(20, 184, 166)',
                borderWidth: 2.5,
                tension: 0.4,
                fill: true,
                pointBackgroundColor: riskScores.map(score => {
                    if (score < 20) return 'rgb(16, 185, 129)';
                    if (score < 40) return 'rgb(245, 158, 11)';
                    if (score < 60) return 'rgb(249, 115, 22)';
                    return 'rgb(239, 68, 68)';
                }),
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: 4,
                pointHoverRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    enabled: true,
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 8,
                    callbacks: {
                        title: function(context) {
                            return context[0].label;
                        },
                        label: function(context) {
                            return 'ìœ„í—˜ë„: ' + context.parsed.y.toFixed(1);
                        }
                    }
                }
            },
            scales: {
                y: {
                    display: true,
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                        display: true,
                        font: {
                            size: 10
                        },
                        color: '#9ca3af'
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)',
                        drawBorder: false
                    }
                },
                x: {
                    display: true,
                    ticks: {
                        font: {
                            size: 10
                        },
                        color: '#9ca3af'
                    },
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
}

function formatDate(dateString) {
    const date = new Date(dateString);
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}
</script>
{% endblock %}
