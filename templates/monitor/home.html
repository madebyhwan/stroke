{% extends 'base.html' %}

{% block title %}ëª¨ë‹ˆí„°ë§ - ë‡Œì¡¸ì¤‘ ê´€ë¦¬{% endblock %}

{% block header_actions %}
<div class="flex items-center gap-3 text-sm">
    <a href="/monitor/profile" class="font-medium hover:text-teal-600 transition cursor-pointer underline" id="userName">ì‚¬ìš©ì</a>ë‹˜
    <button onclick="handleLogout()" class="text-gray-400 hover:text-gray-600">
        <i data-lucide="log-out" class="w-5 h-5"></i>
    </button>
</div>
{% endblock %}

{% block content %}
<div class="space-y-6 pb-20">
    <!-- í™˜ì˜ ë©”ì‹œì§€ -->
    <div class="bg-gradient-to-r from-blue-500 to-indigo-600 rounded-2xl p-6 text-white shadow-lg relative overflow-hidden">
        <div class="relative z-10">
            <h2 class="text-2xl font-bold mb-1">í™˜ì ëª¨ë‹ˆí„°ë§ ğŸ‘¨â€âš•ï¸</h2>
            <p class="text-blue-50 text-sm mb-4" id="welcomeMessage">
                ë“±ë¡í•œ í™˜ìë“¤ì˜ ê±´ê°• ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”
            </p>
        </div>
        <i data-lucide="activity" class="absolute -right-4 -bottom-4 w-32 h-32 text-white/10"></i>
    </div>

    <!-- ëª¨ë‹ˆí„°ë§ ìš”ì²­ ì„¹ì…˜ -->
    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
        <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
            <i data-lucide="user-plus" class="w-5 h-5 text-teal-600"></i>
            í™˜ì ì¶”ê°€í•˜ê¸°
        </h3>
        
        <!-- í™˜ì ê²€ìƒ‰ -->
        <div class="mb-4">
            <div class="flex gap-2">
                <input 
                    type="text" 
                    id="patientSearchInput" 
                    placeholder="í™˜ì ì•„ì´ë”” ì…ë ¥"
                    class="w-16 flex-1 px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-teal-500"
                    onkeypress="if(event.key === 'Enter') { event.preventDefault(); searchPatient(); }"
                />
                <button 
                    onclick="searchPatient()"
                    class="px-6 py-3 bg-blue-600 text-white rounded-xl font-medium hover:bg-blue-700 transition flex items-center gap-2"
                >
                    <i data-lucide="search" class="w-4 h-4"></i>
                    ê²€ìƒ‰
                </button>
            </div>
        </div>

        <!-- ê²€ìƒ‰ ê²°ê³¼ -->
        <div id="searchResult" class="hidden mb-4 p-4 border border-blue-200 bg-blue-50 rounded-xl">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                        <i data-lucide="user" class="w-5 h-5 text-blue-600"></i>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-800" id="foundPatientName">-</h4>
                        <p class="text-xs text-gray-500" id="foundPatientId">-</p>
                        <p class="text-xs text-blue-600" id="foundPatientRole">-</p>
                    </div>
                </div>
                <button 
                    onclick="sendMonitoringRequest()"
                    class="px-4 py-2 bg-teal-600 text-white rounded-lg font-medium hover:bg-teal-700 transition flex items-center gap-2"
                >
                    <i data-lucide="send" class="w-4 h-4"></i>
                    ìš”ì²­
                </button>
            </div>
        </div>

        <p class="text-xs text-gray-500">í™˜ìë¥¼ ê²€ìƒ‰í•œ í›„ ëª¨ë‹ˆí„°ë§ ìš”ì²­ì„ ë³´ë‚¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
    </div>

    <!-- ë‚´ê°€ ë³´ë‚¸ ìš”ì²­ -->
    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
        <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
            <i data-lucide="send" class="w-5 h-5 text-blue-600"></i>
            ë³´ë‚¸ ìš”ì²­
            <span id="pendingRequestCount" class="text-sm font-normal text-gray-500"></span>
        </h3>
        <div id="pendingRequestList" class="space-y-3">
            <!-- ëŒ€ê¸° ì¤‘ì¸ ìš”ì²­ ëª©ë¡ì´ ì—¬ê¸° í‘œì‹œë©ë‹ˆë‹¤ -->
        </div>
        <div id="emptyPendingRequests" class="hidden text-center py-8 text-gray-400">
            <i data-lucide="inbox" class="w-12 h-12 mx-auto mb-2 opacity-50"></i>
            <p class="text-sm">ëŒ€ê¸° ì¤‘ì¸ ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤</p>
        </div>
    </div>

    <!-- ë‚´ í™˜ì ëª©ë¡ -->
    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
        <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
            <i data-lucide="users" class="w-5 h-5 text-teal-600"></i>
            ë“±ë¡ í™˜ì ëª©ë¡
            <span id="patientCount" class="text-sm font-normal text-gray-500"></span>
        </h3>
        <div id="patientList" class="space-y-3">
            <!-- í™˜ì ëª©ë¡ì´ ì—¬ê¸° í‘œì‹œë©ë‹ˆë‹¤ -->
        </div>
        <div id="emptyPatientList" class="hidden text-center py-8 text-gray-400">
            <i data-lucide="inbox" class="w-12 h-12 mx-auto mb-2 opacity-50"></i>
            <p class="text-sm">ë“±ë¡ëœ í™˜ìê°€ ì—†ìŠµë‹ˆë‹¤</p>
            <p class="text-xs">ìœ„ì—ì„œ í™˜ì ì•„ì´ë””ë¡œ ëª¨ë‹ˆí„°ë§ì„ ìš”ì²­í•˜ì„¸ìš”</p>
        </div>
    </div>
</div>

<!-- í™˜ì ìƒì„¸ ëª¨ë‹¬ -->
    </div>
</div>

<!-- í™˜ì ìƒì„¸ ëª¨ë‹¬ -->
<div id="patientDetailModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-gray-800" id="patientDetailName">í™˜ì ìƒì„¸</h3>
                <button onclick="closePatientDetail()" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <!-- ê¸°ë³¸ ì •ë³´ -->
            <div class="bg-gray-50 rounded-xl p-4 mb-4">
                <h4 class="font-semibold text-gray-700 mb-3">ê¸°ë³¸ ì •ë³´</h4>
                <div class="grid grid-cols-2 gap-3 text-sm">
                    <div>
                        <span class="text-gray-500">ì•„ì´ë””</span>
                        <p class="font-medium" id="detailPatientId">-</p>
                    </div>
                    <div>
                        <span class="text-gray-500">ë‚˜ì´</span>
                        <p class="font-medium" id="detailPatientAge">-</p>
                    </div>
                    <div>
                        <span class="text-gray-500">ì„±ë³„</span>
                        <p class="font-medium" id="detailPatientSex">-</p>
                    </div>
                    <div>
                        <span class="text-gray-500">í‚¤</span>
                        <p class="font-medium" id="detailPatientHeight">-</p>
                    </div>
                </div>
            </div>

            <!-- ìµœê·¼ ê±´ê°• ë°ì´í„° -->
            <div class="bg-gray-50 rounded-xl p-4 mb-4">
                <h4 class="font-semibold text-gray-700 mb-3">ìµœê·¼ ê±´ê°• ë°ì´í„°</h4>
                <div id="detailHealthData" class="space-y-2 text-sm">
                    <!-- ê±´ê°• ë°ì´í„°ê°€ ì—¬ê¸° í‘œì‹œë©ë‹ˆë‹¤ -->
                </div>
            </div>

            <!-- ìœ„í—˜ë„ ì ìˆ˜ -->
            <div class="bg-gray-50 rounded-xl p-4">
                <h4 class="font-semibold text-gray-700 mb-3">ë‡Œì¡¸ì¤‘ ìœ„í—˜ë„</h4>
                <div id="detailRiskScore" class="text-center">
                    <div class="text-3xl font-bold mb-1" id="riskScoreValue">-</div>
                    <div class="text-sm text-gray-500" id="riskScoreLabel">ë°ì´í„° ì—†ìŒ</div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// storageëŠ” script.jsì— ì´ë¯¸ ì •ì˜ë˜ì–´ ìˆìœ¼ë¯€ë¡œ ì¬ì„ ì–¸í•˜ì§€ ì•ŠìŒ
let currentUser = null;
let currentPatientDetail = null;
let foundPatient = null; // ê²€ìƒ‰ëœ í™˜ì ì •ë³´ ì €ì¥

// í˜ì´ì§€ ë¡œë“œ ì‹œ ë°ì´í„° ë¡œë“œ
document.addEventListener('DOMContentLoaded', async () => {
    currentUser = storage.get('user');
    
    if (!currentUser || !currentUser.id) {
        window.location.href = '/login';
        return;
    }
    
    // ì˜ì‚¬/ë³´í˜¸ìê°€ ì•„ë‹ˆë©´ í™˜ì í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
    if (currentUser.role === 'PATIENT') {
        window.location.href = '/patient/home';
        return;
    }
    
    // ì‚¬ìš©ì ì´ë¦„ í‘œì‹œ
    document.getElementById('userName').textContent = currentUser.name || 'ì‚¬ìš©ì';
    document.getElementById('welcomeMessage').textContent = 
        `${currentUser.name || 'ì‚¬ìš©ì'}ë‹˜, ë“±ë¡ëœ í™˜ìë“¤ì˜ ê±´ê°• ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”`;
    
    // ë°ì´í„° ë¡œë“œ
    await loadMyPatients();
    await loadPendingRequests();
    
    // ì•„ì´ì½˜ ë Œë”ë§
    lucide.createIcons();
});

// ëŒ€ê¸° ì¤‘ì¸ ìš”ì²­ ë¡œë“œ
async function loadPendingRequests() {
    try {
        const requests = await apiCall(`/monitoring/requests/sent/${currentUser.id}`, 'GET');
        
        // PENDING ìƒíƒœë§Œ í•„í„°ë§
        const pendingRequests = requests.filter(req => req.status === 'PENDING');
        
        const requestList = document.getElementById('pendingRequestList');
        const emptyList = document.getElementById('emptyPendingRequests');
        const countEl = document.getElementById('pendingRequestCount');
        
        if (!pendingRequests || pendingRequests.length === 0) {
            requestList.innerHTML = '';
            emptyList.classList.remove('hidden');
            countEl.textContent = '';
            lucide.createIcons();
            return;
        }
        
        emptyList.classList.add('hidden');
        countEl.textContent = `(${pendingRequests.length}ê±´)`;
        
        requestList.innerHTML = pendingRequests.map(req => `
            <div class="border border-gray-200 bg-gray-50 rounded-xl p-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                            <i data-lucide="clock" class="w-5 h-5 text-blue-600"></i>
                        </div>
                        <div>
                            <h4 class="font-semibold text-gray-800">${req.patient_name}</h4>
                            <p class="text-xs text-gray-500">${formatDate(req.created_at)} ìš”ì²­</p>
                            <p class="text-xs text-blue-600">ì‘ë‹µ ëŒ€ê¸° ì¤‘</p>
                        </div>
                    </div>
                    <button 
                        onclick="cancelRequest('${req.id}', '${req.patient_name}')"
                        class="text-red-500 hover:text-red-700 p-2"
                        title="ìš”ì²­ ì·¨ì†Œ"
                    >
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
        `).join('');
        
        lucide.createIcons();
        
    } catch (error) {
        console.error('ëŒ€ê¸° ì¤‘ì¸ ìš”ì²­ ë¡œë“œ ì˜¤ë¥˜:', error);
    }
}

// ìš”ì²­ ì·¨ì†Œ
async function cancelRequest(requestId, patientName) {
    if (!confirm(`${patientName}ë‹˜ì—ê²Œ ë³´ë‚¸ ìš”ì²­ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        return;
    }
    
    try {
        await apiCall(`/monitoring/request/${requestId}`, 'DELETE');
        showAlert('ìš”ì²­ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        await loadPendingRequests();
    } catch (error) {
        showAlert(error.message || 'ìš”ì²­ ì·¨ì†Œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
    }
}

// ë‚´ í™˜ì ëª©ë¡ ë¡œë“œ
async function loadMyPatients() {
    try {
        const relations = await apiCall(`/monitoring/my-patients/${currentUser.id}`, 'GET');
        
        const patientList = document.getElementById('patientList');
        const emptyList = document.getElementById('emptyPatientList');
        const countEl = document.getElementById('patientCount');
        
        if (!relations || relations.length === 0) {
            patientList.innerHTML = '';
            emptyList.classList.remove('hidden');
            countEl.textContent = '';
            lucide.createIcons();
            return;
        }
        
        emptyList.classList.add('hidden');
        countEl.textContent = `(${relations.length}ëª…)`;
        
        patientList.innerHTML = relations.map(rel => `
            <div class="border border-gray-200 rounded-xl p-4 hover:border-teal-300 transition cursor-pointer" 
                 onclick="showPatientDetail('${rel.patient_id}', '${rel.patient_name}')">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-teal-100 rounded-full flex items-center justify-center">
                            <i data-lucide="user" class="w-5 h-5 text-teal-600"></i>
                        </div>
                        <div>
                            <h4 class="font-semibold text-gray-800">${rel.patient_name}</h4>
                            <p class="text-xs text-gray-500">${rel.patient_id}</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <button 
                            onclick="event.stopPropagation(); removeRelation('${rel.id}', '${rel.patient_name}')"
                            class="text-red-500 hover:text-red-700 p-2"
                            title="ëª¨ë‹ˆí„°ë§ í•´ì œ"
                        >
                            <i data-lucide="user-minus" class="w-4 h-4"></i>
                        </button>
                        <i data-lucide="chevron-right" class="w-5 h-5 text-gray-400"></i>
                    </div>
                </div>
            </div>
        `).join('');
        
        lucide.createIcons();
    } catch (error) {
        console.error('í™˜ì ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
    }
}

// í™˜ì ê²€ìƒ‰
async function searchPatient() {
    const patientId = document.getElementById('patientSearchInput').value.trim();
    
    if (!patientId) {
        showAlert('í™˜ì ì•„ì´ë””ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
        return;
    }
    
    try {
        // ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ
        const patient = await apiCall(`/users/${patientId}`, 'GET');
        
        // í™˜ì ì—­í•  í™•ì¸
        if (patient.role !== 'PATIENT') {
            showAlert('í™˜ì ì—­í• ì˜ ì‚¬ìš©ìë§Œ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'error');
            document.getElementById('searchResult').classList.add('hidden');
            foundPatient = null;
            return;
        }
        
        // ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ
        foundPatient = patient;
        document.getElementById('foundPatientName').textContent = patient.name || 'ì´ë¦„ ì—†ìŒ';
        document.getElementById('foundPatientId').textContent = patient.id;
        document.getElementById('foundPatientRole').textContent = 'í™˜ì';
        document.getElementById('searchResult').classList.remove('hidden');
        
        console.log('[ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ ì™„ë£Œ]');
        lucide.createIcons();
        
    } catch (error) {
        console.error('[ê²€ìƒ‰ ì‹¤íŒ¨]', error);
        showAlert(error.message || 'í™˜ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
        document.getElementById('searchResult').classList.add('hidden');
        foundPatient = null;
    }
}

// ëª¨ë‹ˆí„°ë§ ìš”ì²­ ë³´ë‚´ê¸° (ê²€ìƒ‰ëœ í™˜ìì—ê²Œ)
async function sendMonitoringRequest() {
    if (!foundPatient) {
        showAlert('ë¨¼ì € í™˜ìë¥¼ ê²€ìƒ‰í•´ì£¼ì„¸ìš”.', 'error');
        return;
    }
    
    try {
        const response = await apiCall('/monitoring/request', 'POST', {
            patient_id: foundPatient.id,
            requester_id: currentUser.id
        });
        
        console.log('ëª¨ë‹ˆí„°ë§ ìš”ì²­ ì„±ê³µ:', response);
        showAlert(`${foundPatient.name}ë‹˜ì—ê²Œ ëª¨ë‹ˆí„°ë§ ìš”ì²­ì„ ë³´ëƒˆìŠµë‹ˆë‹¤.`, 'success');
        
        // ì…ë ¥ í•„ë“œì™€ ê²€ìƒ‰ ê²°ê³¼ ì´ˆê¸°í™”
        document.getElementById('patientSearchInput').value = '';
        document.getElementById('searchResult').classList.add('hidden');
        foundPatient = null;
        
        // ëŒ€ê¸° ìš”ì²­ ëª©ë¡ ì—…ë°ì´íŠ¸
        await loadPendingRequests();
        
    } catch (error) {
        console.error('ëª¨ë‹ˆí„°ë§ ìš”ì²­ ì‹¤íŒ¨:', error);
        showAlert(error.message || 'ìš”ì²­ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
    }
}

// ëª¨ë‹ˆí„°ë§ ê´€ê³„ í•´ì œ
async function removeRelation(relationId, patientName) {
    if (!confirm(`${patientName} í™˜ìì˜ ëª¨ë‹ˆí„°ë§ì„ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        return;
    }
    
    try {
        await apiCall(`/monitoring/relation/${relationId}`, 'DELETE');
        showAlert('ëª¨ë‹ˆí„°ë§ ê´€ê³„ê°€ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        await loadMyPatients();
        await loadPendingRequests();
    } catch (error) {
        showAlert(error.message || 'ê´€ê³„ í•´ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
    }
}

// í™˜ì ìƒì„¸ ì •ë³´ ë³´ê¸°
async function showPatientDetail(patientId, patientName) {
    try {
        currentPatientDetail = patientId;
        
        // í™˜ì ê¸°ë³¸ ì •ë³´ ë¡œë“œ
        const patientInfo = await apiCall(`/users/${patientId}`, 'GET');
        
        // í™˜ì ê±´ê°• ë°ì´í„° ë¡œë“œ
        const healthRecords = await apiCall(`/health/records/monitor/${currentUser.id}/patient/${patientId}`, 'GET');
        
        // ëª¨ë‹¬ì— ë°ì´í„° í‘œì‹œ
        document.getElementById('patientDetailName').textContent = patientName;
        document.getElementById('detailPatientId').textContent = patientId;
        
        // ê¸°ë³¸ ì •ë³´
        if (patientInfo.birth_date) {
            const age = calculateAge(patientInfo.birth_date);
            document.getElementById('detailPatientAge').textContent = `${age}ì„¸`;
        }
        document.getElementById('detailPatientSex').textContent = 
            patientInfo.sex === 'M' ? 'ë‚¨ì„±' : patientInfo.sex === 'F' ? 'ì—¬ì„±' : '-';
        document.getElementById('detailPatientHeight').textContent = 
            patientInfo.height_cm ? `${patientInfo.height_cm}cm` : '-';
        
        // ìµœê·¼ ê±´ê°• ë°ì´í„°
        const healthDataEl = document.getElementById('detailHealthData');
        if (healthRecords && healthRecords.length > 0) {
            const latest = healthRecords[0];
            healthDataEl.innerHTML = `
                <div class="flex justify-between">
                    <span class="text-gray-500">ì²´ì¤‘</span>
                    <span class="font-medium">${latest.weight_kg}kg</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-500">í˜ˆì••</span>
                    <span class="font-medium">${latest.systolic_bp}/${latest.diastolic_bp} mmHg</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-500">í˜ˆë‹¹</span>
                    <span class="font-medium">${latest.glucose_level} mg/dL</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-500">í¡ì—°</span>
                    <span class="font-medium">${getSmokingStatus(latest.smoking)}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-500">ì¸¡ì •ì¼</span>
                    <span class="font-medium">${formatDate(latest.created_at)}</span>
                </div>
            `;
            
            // ìœ„í—˜ë„ ì ìˆ˜
            if (latest.stroke_risk_score !== undefined) {
                displayRiskScore(latest.stroke_risk_score);
            }
        } else {
            healthDataEl.innerHTML = '<p class="text-gray-400 text-center py-4">ê±´ê°• ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</p>';
            document.getElementById('riskScoreValue').textContent = '-';
            document.getElementById('riskScoreLabel').textContent = 'ë°ì´í„° ì—†ìŒ';
        }
        
        // ëª¨ë‹¬ í‘œì‹œ
        document.getElementById('patientDetailModal').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
        lucide.createIcons();
        
    } catch (error) {
        console.error('í™˜ì ìƒì„¸ ì •ë³´ ë¡œë“œ ì˜¤ë¥˜:', error);
        showAlert(error.message || 'í™˜ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
    }
}

function closePatientDetail() {
    document.getElementById('patientDetailModal').classList.add('hidden');
    document.body.style.overflow = '';
    currentPatientDetail = null;
}

// ìœ„í—˜ë„ ì ìˆ˜ í‘œì‹œ
function displayRiskScore(score) {
    const valueEl = document.getElementById('riskScoreValue');
    const labelEl = document.getElementById('riskScoreLabel');
    
    valueEl.textContent = score.toFixed(1);
    
    if (score < 3) {
        valueEl.className = 'text-3xl font-bold mb-1 text-green-600';
        labelEl.textContent = 'ë‚®ìŒ';
        labelEl.className = 'text-sm text-green-600';
    } else if (score < 7) {
        valueEl.className = 'text-3xl font-bold mb-1 text-yellow-600';
        labelEl.textContent = 'ì¤‘ê°„';
        labelEl.className = 'text-sm text-yellow-600';
    } else {
        valueEl.className = 'text-3xl font-bold mb-1 text-red-600';
        labelEl.textContent = 'ë†’ìŒ';
        labelEl.className = 'text-sm text-red-600';
    }
}

// ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
function calculateAge(birthDate) {
    const today = new Date();
    const birth = new Date(birthDate);
    let age = today.getFullYear() - birth.getFullYear();
    const monthDiff = today.getMonth() - birth.getMonth();
    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
        age--;
    }
    return age;
}

function getSmokingStatus(smoking) {
    const status = { 0: 'ë¹„í¡ì—°', 1: 'ê³¼ê±° í¡ì—°', 2: 'í˜„ì¬ í¡ì—°' };
    return status[smoking] || '-';
}

function formatDate(dateString) {
    const date = new Date(dateString);
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}
function handleLogout() {
    if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        storage.clear();
        window.location.href = '/login';
    }
}
</script>
{% endblock %}
