{% extends 'base.html' %}

{% block title %}프로필 수정 - 뇌졸중 관리{% endblock %}

{% block header_actions %}
<button onclick="goBack()" class="text-gray-600 hover:text-gray-800">
    <i data-lucide="arrow-left" class="w-5 h-5"></i>
</button>
{% endblock %}

{% block content %}
<div class="space-y-6 pb-10">
    <!-- 페이지 제목 -->
    <div class="text-center mb-6">
        <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-full mb-3">
            <i data-lucide="user-cog" class="w-8 h-8 text-white"></i>
        </div>
        <h2 class="text-2xl font-bold text-gray-800">프로필 수정</h2>
        <p class="text-gray-500 text-sm mt-1">이름과 비밀번호를 변경할 수 있습니다</p>
    </div>

    <!-- 현재 사용자 정보 표시 -->
    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-2xl p-6 border border-blue-100">
        <div class="flex items-center gap-4">
            <div class="w-16 h-16 bg-blue-500 rounded-full flex items-center justify-center">
                <span class="text-2xl text-white font-bold" id="userInitial">-</span>
            </div>
            <div>
                <p class="text-sm text-gray-500">현재 로그인</p>
                <p class="text-lg font-bold text-gray-800" id="currentName">-</p>
                <p class="text-sm text-gray-600" id="currentId">-</p>
                <p class="text-xs text-blue-600 font-medium mt-1" id="currentRole">-</p>
            </div>
        </div>
    </div>

    <!-- 이름 변경 폼 -->
    <div class="bg-white rounded-2xl shadow-sm p-6 border border-gray-100">
        <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
            <i data-lucide="user" class="w-5 h-5 text-blue-600"></i>
            이름 변경
        </h3>
        
        <form id="nameForm" onsubmit="handleNameChange(event)" class="space-y-4">
            <div>
                <label for="newName" class="block text-sm font-medium text-gray-700 mb-2">
                    새 이름 <span class="text-red-500">*</span>
                </label>
                <input 
                    type="text" 
                    id="newName" 
                    name="newName" 
                    required
                    minlength="2"
                    maxlength="20"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition"
                    placeholder="변경할 이름을 입력하세요"
                >
            </div>

            <button 
                type="submit" 
                class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white py-3 rounded-lg font-semibold hover:from-blue-700 hover:to-indigo-700 transition duration-300 flex items-center justify-center gap-2"
            >
                <span>이름 변경</span>
                <i data-lucide="check" class="w-5 h-5"></i>
            </button>
        </form>
    </div>

    <!-- 비밀번호 변경 폼 -->
    <div class="bg-white rounded-2xl shadow-sm p-6 border border-gray-100">
        <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
            <i data-lucide="lock" class="w-5 h-5 text-blue-600"></i>
            비밀번호 변경
        </h3>
        
        <form id="passwordForm" onsubmit="handlePasswordChange(event)" class="space-y-4">
            <div>
                <label for="currentPassword" class="block text-sm font-medium text-gray-700 mb-2">
                    현재 비밀번호 <span class="text-red-500">*</span>
                </label>
                <input 
                    type="password" 
                    id="currentPassword" 
                    name="currentPassword" 
                    required
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition"
                    placeholder="현재 비밀번호"
                >
            </div>

            <div>
                <label for="newPassword" class="block text-sm font-medium text-gray-700 mb-2">
                    새 비밀번호 <span class="text-red-500">*</span>
                </label>
                <input 
                    type="password" 
                    id="newPassword" 
                    name="newPassword" 
                    required
                    minlength="4"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition"
                    placeholder="새 비밀번호 (4자 이상)"
                >
            </div>

            <div>
                <label for="confirmPassword" class="block text-sm font-medium text-gray-700 mb-2">
                    비밀번호 확인 <span class="text-red-500">*</span>
                </label>
                <input 
                    type="password" 
                    id="confirmPassword" 
                    name="confirmPassword" 
                    required
                    minlength="4"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition"
                    placeholder="비밀번호 재입력"
                >
            </div>

            <button 
                type="submit" 
                class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white py-3 rounded-lg font-semibold hover:from-blue-700 hover:to-indigo-700 transition duration-300 flex items-center justify-center gap-2"
            >
                <span>비밀번호 변경</span>
                <i data-lucide="key" class="w-5 h-5"></i>
            </button>
        </form>
    </div>

    <!-- 로그아웃 버튼 -->
    <div class="bg-white rounded-2xl shadow-sm p-6 border border-gray-100">
        <button 
            onclick="handleLogout()" 
            class="w-full bg-red-50 text-red-600 py-3 rounded-lg font-semibold hover:bg-red-100 transition duration-300 flex items-center justify-center gap-2"
        >
            <i data-lucide="log-out" class="w-5 h-5"></i>
            <span>로그아웃</span>
        </button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 페이지 로드 시 사용자 정보 표시
document.addEventListener('DOMContentLoaded', () => {
    const user = storage.get('user');
    
    if (!user || !user.id) {
        window.location.href = '/login';
        return;
    }
    
    // 현재 사용자 정보 표시
    document.getElementById('currentName').textContent = user.name || '-';
    document.getElementById('currentId').textContent = user.id || '-';
    document.getElementById('userInitial').textContent = user.name ? user.name.charAt(0).toUpperCase() : '-';
    
    const roleText = user.role === 'DOCTOR' ? '의사' : user.role === 'CAREGIVER' ? '보호자' : '환자';
    document.getElementById('currentRole').textContent = roleText;
    
    lucide.createIcons();
});

// 이름 변경
async function handleNameChange(event) {
    event.preventDefault();
    
    const user = storage.get('user');
    const newName = document.getElementById('newName').value.trim();
    
    if (!newName) {
        showAlert('새 이름을 입력해주세요.', 'error');
        return;
    }
    
    if (newName === user.name) {
        showAlert('현재 이름과 동일합니다.', 'error');
        return;
    }
    
    try {
        await apiCall(`/users/${user.id}`, 'PUT', {
            id: user.id,
            name: newName
        });
        
        // 로컬 스토리지 업데이트
        user.name = newName;
        storage.set('user', user);
        
        // UI 업데이트
        document.getElementById('currentName').textContent = newName;
        document.getElementById('userInitial').textContent = newName.charAt(0).toUpperCase();
        document.getElementById('newName').value = '';
        
        showAlert('이름이 변경되었습니다.', 'success');
        
    } catch (error) {
        showAlert(error.message || '이름 변경에 실패했습니다.', 'error');
    }
}

// 비밀번호 변경
async function handlePasswordChange(event) {
    event.preventDefault();
    
    const user = storage.get('user');
    const currentPassword = document.getElementById('currentPassword').value;
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    
    if (!currentPassword || !newPassword || !confirmPassword) {
        showAlert('모든 필드를 입력해주세요.', 'error');
        return;
    }
    
    if (newPassword !== confirmPassword) {
        showAlert('새 비밀번호가 일치하지 않습니다.', 'error');
        return;
    }
    
    if (newPassword.length < 4) {
        showAlert('비밀번호는 최소 4자 이상이어야 합니다.', 'error');
        return;
    }
    
    try {
        // 현재 비밀번호 확인을 위해 로그인 시도
        await apiCall('/users/login', 'POST', {
            id: user.id,
            password: currentPassword
        });
        
        // 비밀번호 변경
        await apiCall(`/users/${user.id}`, 'PUT', {
            id: user.id,
            password: newPassword
        });
        
        // 즉시 로그아웃
        storage.clear();
        window.location.href = '/login';
        
    } catch (error) {
        showAlert(error.message || '비밀번호 변경에 실패했습니다.', 'error');
    }
}

// 로그아웃
function handleLogout() {
    if (confirm('로그아웃 하시겠습니까?')) {
        storage.clear();
        window.location.href = '/login';
    }
}

function goBack() {
    window.history.back();
}
</script>
{% endblock %}
